<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Puzzle Heroes RPG: Final Version</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Verdana&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');
        
        body { font-family: 'Fredoka One', 'Verdana', sans-serif; background-color: #0f172a; color: #ffffff; overflow: hidden; touch-action: none; user-select: none; -webkit-user-select: none; }
        .game-font { text-shadow: 2px 2px 0px #000; letter-spacing: 1px; }
        
        /* ANIMASI LENGKAP (DARI KODE LAMA) */
        @keyframes sway-hero { 0%, 100% { transform: translateX(-3px); } 50% { transform: translateX(3px); } }
        @keyframes sway-enemy { 0%, 100% { transform: translateX(3px); } 50% { transform: translateX(-3px); } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-6px); } }
        @keyframes punch-pop { 0% { transform: scale(0) rotate(-45deg); opacity: 0; } 40% { transform: scale(1.5) rotate(0deg); opacity: 1; } 60% { transform: scale(1.2) rotate(10deg); } 100% { transform: scale(1.5) translateY(-20px); opacity: 0; } }
        @keyframes hit-shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-6px) rotate(-2deg); filter: brightness(2) sepia(1) hue-rotate(-50deg); } 40%, 80% { transform: translateX(6px) rotate(2deg); } }
        @keyframes particle-pop { 0% { transform: scale(0.5) translateY(0); opacity: 1; } 100% { transform: scale(1.5) translateY(-30px); opacity: 0; } }
        @keyframes crumble { 0% { transform: scale(1) translateY(0) rotate(0deg); opacity: 1; filter: brightness(1.5); } 100% { transform: scale(0.2) translateY(20px) rotate(45deg); opacity: 0; } }
        @keyframes bomb-flash { 0% { background-color: rgba(255,255,255,0); } 50% { background-color: rgba(255,255,255,0.8); } 100% { background-color: rgba(255,255,255,0); } }
        @keyframes float-up-fade { 0% { transform: translate(-50%, 0) scale(1); opacity: 1; } 80% { opacity: 1; } 100% { transform: translate(-50%, -60px) scale(1.2); opacity: 0; } }
        @keyframes drop-in { 0% { transform: translateY(-100%); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }

        .anim-float { animation: float 4s ease-in-out infinite; }
        .anim-sway-hero { animation: sway-hero 2s ease-in-out infinite; }
        .anim-sway-enemy { animation: sway-enemy 2s ease-in-out infinite; }
        .anim-punch { animation: punch-pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; z-index: 100; pointer-events: none; }
        .anim-hit { animation: hit-shake 0.4s ease-in-out; }
        .anim-particle { animation: particle-pop 0.6s ease-out forwards; pointer-events: none; }
        .anim-crumble { animation: crumble 0.4s ease-in forwards; pointer-events: none; }
        .anim-bomb { animation: bomb-flash 0.5s ease-out; }
        .anim-modal { animation: drop-in 0.3s cubic-bezier(0.25, 1, 0.5, 1) backwards; }
        
        .css-board-frame { background: rgba(15, 23, 42, 0.8); border: 8px solid #334155; border-radius: 12px; box-shadow: 0 0 0 2px #1e293b, inset 0 0 20px rgba(0,0,0,0.8), 0 10px 20px rgba(0,0,0,0.5); }
        .css-hp-bar { background: #1e293b; border: 3px solid #475569; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.5); position: relative; overflow: hidden; }
        .btn-game { border-bottom-width: 2px; transition: all 0.1s; }
        .btn-game:active { border-bottom-width: 0px; transform: translateY(2px) scale(0.95); }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXxNettfJao-Eb-Y_a1dNuZ8_DOiX_-fo",
            authDomain: "puzzle-heroes-d5df2.firebaseapp.com",
            projectId: "puzzle-heroes-d5df2",
            storageBucket: "puzzle-heroes-d5df2.firebasestorage.app",
            messagingSenderId: "63425481716",
            appId: "1:63425481716:web:e496e835b3d071235cc7a1",
            measurementId: "G-TCN0MV463X"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        window.loginGoogle = async () => { try { const r = await signInWithPopup(auth, provider); return r.user; } catch (e) { alert(e.message); return null; } };
        window.logoutGoogle = async () => { try { await signOut(auth); window.location.reload(); } catch (e) { console.error(e); } };
        window.authListener = (cb) => { onAuthStateChanged(auth, (u) => cb(u)); };
        
        window.loadCloudData = async (uid) => {
            if (!uid) return null;
            try { const d = await getDoc(doc(db, "players", uid.toString())); return d.exists() ? d.data() : null; } catch (e) { return null; }
        };
        window.saveCloudData = async (uid, data) => {
            if (!uid) return;
            try { await setDoc(doc(db, "players", uid.toString()), data, { merge: true }); } catch (e) { console.error(e); }
        };
    </script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // ASSETS & CONFIG
        const ASSETS = {
          hero: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120266/hero_knqmzd.png",
          enemy_goblin: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120266/monster_goblin_lcvfpv.png",
          enemy_boss: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120266/monster_bos_tn2b0a.png",
          bg_main: "https://res.cloudinary.com/dsutaioqw/image/upload/v1/puzzle%20hero/bg_main.png",
          gem_fire: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120267/gem-fire_rhcs6t.png", 
          gem_water: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120266/gem_water_yk5zsx.png",
          gem_nature: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120267/gem_nature_jj3l1g.png",
          gem_lightning: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120267/gem_lightning_lu9s2z.png",
          gem_shield: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120267/gem_shield_bdizjp.png",
        };
        const GEM_CONFIG = {
          red: { assetKey: 'gem_fire', effect: 'dmg', val: 1.0 },
          blue: { assetKey: 'gem_water', effect: 'dmg', val: 1.0 },
          yellow: { assetKey: 'gem_lightning', effect: 'dmg', val: 1.5 },
          green: { assetKey: 'gem_nature', effect: 'heal', val: 1.5 },
          purple: { assetKey: 'gem_shield', effect: 'shd', val: 2.0 },
        };
        const BOARD_ROWS = 7; const BOARD_COLS = 6;
        const GEM_TYPES = ['red', 'blue', 'green', 'yellow', 'purple'];
        const formatNumber = (n) => n >= 1000000 ? (n/1000000).toFixed(2)+'M' : (n>=1000?(n/1000).toFixed(1)+'K':n);
        
        const SmartImage = ({ assetKey, className }) => <img src={ASSETS[assetKey]} className={`w-full h-full object-contain ${className}`} onError={(e)=>e.target.style.opacity=0} />;

        function GameApp() {
            const tg = window.Telegram.WebApp;
            const [user, setUser] = useState(null);
            const [isTelegram, setIsTelegram] = useState(!!tg.initDataUnsafe?.user);
            const activeUserId = isTelegram ? tg.initDataUnsafe.user.id : (user ? user.uid : (localStorage.getItem('guest_player_id') || 'guest_'+Date.now()));
            const activeUserName = isTelegram ? tg.initDataUnsafe.user.first_name : (user ? user.displayName : (localStorage.getItem('guest_player_name') || "Guest"));

            if(!localStorage.getItem('guest_player_id')) localStorage.setItem('guest_player_id', activeUserId);

            // --- STATE UTAMA ---
            const [gameState, setGameState] = useState('START'); // START, BATTLE, SHOP, REWARD, GAMEOVER, REVIVE
            const [level, setLevel] = useState(1);
            const [totalCoins, setTotalCoins] = useState(100);
            const [bonusStats, setBonusStats] = useState({ hp: 0, atk: 0 });
            const [inventory, setInventory] = useState({ potion: 1, bomb: 0, shuffle: 1 });
            const [itemCounts, setItemCounts] = useState({ potion:0, bomb:0, shuffle:0, atk:0, hp:0 }); // Utk Inflasi
            const [isCloudLoaded, setIsCloudLoaded] = useState(false);

            // --- FORMULA EKONOMI ---
            const getItemPrice = (type) => {
                const base = { potion: 50, bomb: 100, shuffle: 30 };
                const count = itemCounts[type] || 0;
                return Math.floor(base[type] * (1 + (count * 0.1))); // Naik 10% per beli
            };
            const getUpgradePrice = (type) => {
                const base = { atk: 200, hp: 200 };
                const count = itemCounts[type] || 0;
                return Math.floor(base[type] * Math.pow(1.15, count)); // Naik 15% per level
            };
            const getRevivePrice = () => 200 + (level * 100); // Naik sesuai level
            // --- GAMEPLAY STATES ---
            const calculateHeroStats = (lvl, bonuses) => {
                const baseHp = Math.floor(100 * Math.pow(1.07, lvl - 1));
                const baseAtk = Math.floor(15 * Math.pow(1.07, lvl - 1));
                return { maxHp: baseHp + bonuses.hp, hp: baseHp + bonuses.hp, atk: baseAtk + bonuses.atk, shield: 0 };
            };

            const [hero, setHero] = useState(calculateHeroStats(1, {hp:0, atk:0}));
            const [enemy, setEnemy] = useState({ name: 'Loading', hp: 100, maxHp: 100, atk: 10 });
            const [board, setBoard] = useState([]);
            const [turn, setTurn] = useState('player'); 
            const [turnBanner, setTurnBanner] = useState(''); 
            const [isProcessing, setIsProcessing] = useState(false);
            
            // VISUALS
            const [heroAnim, setHeroAnim] = useState('');
            const [enemyAnim, setEnemyAnim] = useState('');
            const [punchEffect, setPunchEffect] = useState(null); 
            const [particles, setParticles] = useState([]);
            const [floatingText, setFloatingText] = useState([]);
            const [dragState, setDragState] = useState(null); 
            const [crushingCells, setCrushingCells] = useState([]); 
            const [screenFlash, setScreenFlash] = useState('');
            const [showIAP, setShowIAP] = useState(false);
            const [showProfileModal, setShowProfileModal] = useState(false);

            // --- LOAD DATA ---
            useEffect(() => {
                const init = async () => {
                    if(window.loadCloudData) {
                        const d = await window.loadCloudData(activeUserId);
                        if(d) {
                            if(d.level) setLevel(d.level);
                            if(d.totalCoins) setTotalCoins(d.totalCoins);
                            if(d.bonusStats) setBonusStats(d.bonusStats);
                            if(d.inventory) setInventory(d.inventory);
                            if(d.itemCounts) setItemCounts(d.itemCounts);
                        }
                    }
                    setIsCloudLoaded(true);
                };
                init();
                if(!isTelegram && window.authListener) window.authListener(setUser);
                tg.ready(); tg.expand();
            }, [activeUserId]);

            // AUTO SAVE
            useEffect(() => {
                if(!isCloudLoaded) return;
                const timer = setTimeout(() => {
                    if(window.saveCloudData) window.saveCloudData(activeUserId, {
                        level, totalCoins, bonusStats, inventory, itemCounts,
                        lastUpdated: Date.now(), username: activeUserName
                    });
                }, 2000);
                return () => clearTimeout(timer);
            }, [level, totalCoins, bonusStats, inventory, itemCounts, isCloudLoaded]);

            // UPDATE STATS SAAT LEVEL NAIK
            useEffect(() => {
                if(isCloudLoaded) {
                    setHero(prev => {
                        const newStats = calculateHeroStats(level, bonusStats);
                        // Kalau REVIVE, HP jangan direset full disini, tapi di logic revive
                        if(gameState === 'REVIVE') return prev; 
                        return { ...newStats, hp: newStats.maxHp };
                    });
                    
                    const isBoss = level % 5 === 0;
                    const mult = isBoss ? 2.5 : 1;
                    const eHp = Math.floor(100 * Math.pow(1.08, level) * mult);
                    setEnemy({
                        name: isBoss ? `BOSS Lv.${level}` : `Monster Lv.${level}`,
                        maxHp: eHp, hp: eHp, 
                        atk: Math.floor(10 * Math.pow(1.08, level) * (isBoss?1.5:1)),
                        isBoss
                    });
                }
            }, [level, bonusStats, isCloudLoaded]);

            // --- BOARD LOGIC (VERSI STABIL) ---
            function createValidBoard() {
                let newBoard, isValid = false;
                while (!isValid) {
                    newBoard = [];
                    for (let r = 0; r < BOARD_ROWS; r++) {
                        const row = [];
                        for (let c = 0; c < BOARD_COLS; c++) row.push(GEM_TYPES[Math.floor(Math.random() * GEM_TYPES.length)]);
                        newBoard.push(row);
                    }
                    if (checkMatches(newBoard).length === 0) isValid = true;
                }
                return newBoard;
            }

            function checkMatches(boardToCheck) {
                const matched = new Set();
                for (let r = 0; r < BOARD_ROWS; r++) {
                    for (let c = 0; c < BOARD_COLS - 2; c++) {
                        const type = boardToCheck[r][c];
                        if (type && boardToCheck[r][c+1] === type && boardToCheck[r][c+2] === type) { matched.add(`${r},${c}`); matched.add(`${r},${c+1}`); matched.add(`${r},${c+2}`); }
                    }
                }
                for (let r = 0; r < BOARD_ROWS - 2; r++) {
                    for (let c = 0; c < BOARD_COLS; c++) {
                        const type = boardToCheck[r][c];
                        if (type && boardToCheck[r+1][c] === type && boardToCheck[r+2][c] === type) { matched.add(`${r},${c}`); matched.add(`${r+1},${c}`); matched.add(`${r+2},${c}`); }
                    }
                }
                return Array.from(matched).map(str => { const [r, c] = str.split(',').map(Number); return { r, c }; });
            }

            const resolveBoard = async (currentBoard) => {
                let activeBoard = currentBoard.map(row => [...row]); 
                let hasMatches = true;
                let loopCount = 0;
                while (hasMatches && loopCount < 10) {
                    const matches = checkMatches(activeBoard);
                    if (matches.length > 0) {
                        let totalDmg = 0, totalHeal = 0, totalShield = 0;
                        setCrushingCells(matches.map(m => `${m.r},${m.c}`));
                        matches.forEach(m => {
                            const type = activeBoard[m.r][m.c];
                            if (type) {
                                const newPart = { id: Date.now()+Math.random(), top: `${(m.r*100/BOARD_ROWS)+7}%`, left: `${(m.c*100/BOARD_COLS)+8}%`, type };
                                setParticles(p => [...p, newPart]); setTimeout(()=>setParticles(p=>p.filter(x=>x.id!==newPart.id)),600);
                                
                                const conf = GEM_CONFIG[type];
                                if (conf.effect === 'dmg') totalDmg += hero.atk * conf.val;
                                if (conf.effect === 'heal') totalHeal += (hero.maxHp * 0.05) * conf.val; 
                                if (conf.effect === 'shd') totalShield += 10 * conf.val; 
                            }
                        });

                        if (totalDmg > 0) { 
                            setEnemy(prev => ({...prev, hp: Math.max(0, prev.hp - Math.floor(totalDmg))})); 
                            setPunchEffect('enemy'); setEnemyAnim('anim-hit'); setTimeout(()=>setEnemyAnim(''),300); setTimeout(()=>setPunchEffect(null),600);
                            const id=Date.now(); setFloatingText(p=>[...p,{id, txt:`-${Math.floor(totalDmg)}`, col:'#ef4444'}]); setTimeout(()=>setFloatingText(p=>p.filter(x=>x.id!==id)),1500);
                            tg.HapticFeedback.impactOccurred('light'); 
                        }
                        if (totalHeal > 0) { setHero(prev => ({...prev, hp: Math.min(prev.maxHp, prev.hp + Math.floor(totalHeal))})); }
                        if (totalShield > 0) { setHero(prev => ({...prev, shield: prev.shield + Math.floor(totalShield)})); }

                        await new Promise(r => setTimeout(r, 400));
                        setCrushingCells([]); 
                        matches.forEach(m => activeBoard[m.r][m.c] = null);
                        setBoard(activeBoard.map(row => [...row])); 
                        await new Promise(r => setTimeout(r, 100)); 
                        for(let c=0; c<BOARD_COLS; c++) {
                             let empty = 0;
                             for(let r=BOARD_ROWS-1; r>=0; r--) {
                                 if(activeBoard[r][c] === null) empty++;
                                 else if(empty > 0) { activeBoard[r+empty][c] = activeBoard[r][c]; activeBoard[r][c] = null; }
                             }
                             for(let i=0; i<empty; i++) activeBoard[i][c] = GEM_TYPES[Math.floor(Math.random() * GEM_TYPES.length)];
                        }
                        setBoard(activeBoard.map(row => [...row])); 
                        await new Promise(r => setTimeout(r, 400)); 
                        loopCount++;
                    } else hasMatches = false;
                }
                setIsProcessing(false);
                setTurn('enemy'); 
                setTurnBanner("GILIRAN MUSUH");
                setTimeout(() => setTurnBanner(''), 1500);
            };

            // INITIAL BOARD
            useEffect(() => { setBoard(createValidBoard()); }, []);

            // ENEMY TURN
            useEffect(() => {
                if (turn === 'enemy' && enemy.hp > 0 && gameState === 'BATTLE' && !isProcessing) {
                    const enemyAct = async () => {
                        setIsProcessing(true);
                        await new Promise(r => setTimeout(r, 1500));
                        const rawDmg = Math.max(5, enemy.atk);
                        let finalDmg = rawDmg, shieldLeft = hero.shield;
                        if (shieldLeft > 0) {
                            if (shieldLeft >= finalDmg) { shieldLeft -= finalDmg; finalDmg = 0; }
                            else { finalDmg -= shieldLeft; shieldLeft = 0; }
                        }
                        setHero(h => ({...h, hp: Math.max(0, h.hp - finalDmg), shield: shieldLeft}));
                        if(finalDmg > 0) { 
                            setHeroAnim('anim-hit'); setTimeout(()=>setHeroAnim(''),300);
                            const id=Date.now(); setFloatingText(p=>[...p,{id, txt:`-${finalDmg}`, col:'#ef4444'}]); setTimeout(()=>setFloatingText(p=>p.filter(x=>x.id!==id)),1500);
                            tg.HapticFeedback.notificationOccurred('warning'); 
                        }
                        await new Promise(r => setTimeout(r, 1000));
                        setTurn('player'); setTurnBanner('GILIRAN KAMU'); setTimeout(() => setTurnBanner(''), 1500); setIsProcessing(false);
                    }
                    enemyAct();
                }
            }, [turn, gameState, isProcessing]);

            // INPUT HANDLING
            const handleDragStart = (e, r, c) => {
                if (isProcessing || turn !== 'player') return;
                const cx = e.touches ? e.touches[0].clientX : e.clientX, cy = e.touches ? e.touches[0].clientY : e.clientY;
                setDragState({ r, c, x: cx, y: cy });
            };
            const handleDragEnd = (e) => {
                if (!dragState) return;
                const cx = e.changedTouches ? e.changedTouches[0].clientX : e.clientX, cy = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
                const dx = cx - dragState.x, dy = cy - dragState.y;
                if (Math.abs(dx) > 30 || Math.abs(dy) > 30) {
                     const targetR = Math.abs(dy) > Math.abs(dx) ? (dy > 0 ? dragState.r + 1 : dragState.r - 1) : dragState.r;
                     const targetC = Math.abs(dx) > Math.abs(dy) ? (dx > 0 ? dragState.c + 1 : dragState.c - 1) : dragState.c;
                     if (targetR >= 0 && targetR < BOARD_ROWS && targetC >= 0 && targetC < BOARD_COLS) {
                         const tempBoard = board.map(row => [...row]);
                         [tempBoard[dragState.r][dragState.c], tempBoard[targetR][targetC]] = [tempBoard[targetR][targetC], tempBoard[dragState.r][dragState.c]];
                         if (checkMatches(tempBoard).length > 0) { setIsProcessing(true); setBoard(tempBoard); setTimeout(() => { resolveBoard(tempBoard); }, 200); } 
                     }
                }
                setDragState(null);
            };

            // WIN / LOSE
            useEffect(() => {
                if (enemy.hp <= 0 && gameState === 'BATTLE') { 
                    setTimeout(() => { setGameState('REWARD'); tg.HapticFeedback.notificationOccurred('success'); }, 1000); 
                }
                if (hero.hp <= 0 && gameState === 'BATTLE') setGameState('REVIVE'); // KE REVIVE MENU
            }, [enemy.hp, hero.hp]);
            // --- ACTIONS ---
            const handleNextLevel = () => {
                const rwd = Math.floor(15 * Math.pow(1.085, level - 1));
                setTotalCoins(prev => prev + rwd);
                setLevel(prev => prev + 1);
                setGameState('BATTLE'); setTurnBanner('START!'); setTimeout(()=>setTurnBanner(''), 1500); setTurn('player'); setIsProcessing(false);
            };

            const handleRevive = (method) => {
                if(method === 'star') {
                    // LINK INVOICE 1 STAR (GANTI DENGAN PUNYA ANDA)
                    const invLink = "https://t.me/$D8iuOsDkIFQgBAAAUoNG2nbqTHI"; 
                    if(isTelegram) {
                        tg.openInvoice(invLink, (s) => {
                            if(s==='paid') { setHero(h=>({...h, hp:h.maxHp})); setGameState('BATTLE'); }
                        });
                    } else {
                        // Simulasi Browser
                        setHero(h=>({...h, hp:h.maxHp})); setGameState('BATTLE');
                    }
                } else {
                    const price = getRevivePrice();
                    if(totalCoins >= price) {
                        setTotalCoins(c => c - price);
                        setHero(h=>({...h, hp: Math.floor(h.maxHp * 0.5)}));
                        setGameState('BATTLE');
                    } else tg.showAlert("Koin tidak cukup!");
                }
            };

            const handleGiveUp = () => {
                if(confirm("Yakin menyerah? Stage reset ke 1, tapi Stats & Item AMAN.")) {
                    setLevel(1);
                    setHero(h=>({...h, hp: h.maxHp}));
                    setGameState('BATTLE');
                    setBoard(createValidBoard());
                }
            };

            const buyItem = (type) => {
                const p = getItemPrice(type);
                if(totalCoins >= p) {
                    setTotalCoins(c => c - p);
                    setInventory(i => ({...i, [type]: i[type]+1}));
                    setItemCounts(c => ({...c, [type]: (c[type]||0)+1}));
                }
            };
            const upgradeStats = (type) => {
                const p = getUpgradePrice(type);
                if(totalCoins >= p) {
                    setTotalCoins(c => c - p);
                    if(type==='atk') setBonusStats(s=>({...s, atk:s.atk+2}));
                    if(type==='hp') { setBonusStats(s=>({...s, hp:s.hp+10})); setHero(h=>({...h, hp:h.hp+10, maxHp:h.maxHp+10})); }
                    setItemCounts(c => ({...c, [type]: (c[type]||0)+1}));
                }
            };

            const handleProfile = () => {
                if(isTelegram) {
                    if(user) { tg.showConfirm(`Login: ${user.displayName}\nLogout?`, (ok)=> ok && window.logoutGoogle()); }
                    else {
                        tg.showPopup({ title:'Guest', message:'Pilih Opsi:', buttons:[{id:'login', type:'default', text:'Login Google'}, {id:'rename', type:'default', text:'Ganti Nama'}, {id:'cancel', type:'destructive', text:'Tutup'}] }, 
                        (id) => { if(id==='login') window.loginGoogle(); if(id==='rename') { const n=prompt("Nama:", activeUserName); if(n) {localStorage.setItem('guest_player_name',n); window.location.reload();} } });
                    }
                } else setShowProfileModal(true);
            };

            return (
                <div className="flex flex-col h-screen w-full select-none relative overflow-hidden"
                     onMouseUp={handleDragEnd} onTouchEnd={handleDragEnd}>
                     
                    <div className={`absolute inset-0 z-50 pointer-events-none ${screenFlash}`}></div>
                    <div className="absolute inset-0 z-0 bg-slate-900"><img src={ASSETS.bg_main} className="w-full h-full object-cover opacity-40"/></div>

                    {turnBanner && <div className="absolute top-40 w-full text-center z-50 text-4xl font-black text-white animate-pulse game-font drop-shadow-lg">{turnBanner}</div>}
                    
                    <div className="absolute top-0 w-full z-40 p-2 flex justify-between items-start">
                        <div onClick={()=>setGameState('SHOP')} className="flex items-center gap-2 bg-slate-900/80 border-2 border-yellow-600 rounded-full px-4 py-1 shadow-lg active:scale-95 transition-transform">
                            <span>üí∞</span><span className="text-yellow-400 font-black text-lg game-font">{formatNumber(totalCoins)}</span>
                        </div>
                        <div className="flex flex-col items-center"><span className="text-white/90 font-black text-xl tracking-[0.2em] drop-shadow-md game-font">STAGE {level}</span></div>
                        <div onClick={handleProfile} className="flex flex-col items-end active:scale-95 transition-transform">
                             <div className="text-[10px] text-yellow-500 font-bold">PLAYER</div>
                             <div className="text-sm font-bold text-white flex gap-1">{activeUserName} <span className="opacity-50">{user?'üåê':'‚úèÔ∏è'}</span></div>
                        </div>
                    </div>

                    <div className="flex flex-col justify-between h-full py-4 pb-0 pt-0 relative z-10">
                        <div className="relative flex flex-col items-center mt-6"> 
                            <div className={`relative w-32 h-32 ${enemyAnim} anim-sway-enemy z-30`}>
                                 {enemy.isBoss && <div className="absolute top-8 -left-12 w-20 h-20 opacity-80 z-0"><SmartImage assetKey="enemy_goblin" /></div>}
                                 <SmartImage assetKey={enemy.isBoss ? 'enemy_boss' : 'enemy_goblin'} className="drop-shadow-2xl z-20 relative" />
                            </div>
                            <div className="relative w-64 h-8 css-hp-bar -mt-4 z-20"><div className="absolute top-0 left-0 h-full bg-red-600 transition-all duration-300" style={{width: `${(enemy.hp/enemy.maxHp)*100}%`}}></div><div className="absolute inset-0 flex items-center justify-between px-3 text-xs font-bold text-white game-font z-10"><span>{enemy.name}</span><span>{formatNumber(enemy.hp)}</span></div></div>
                            {punchEffect==='enemy' && <div className="absolute top-20 z-50 text-6xl anim-punch">üëä</div>}
                        </div>

                        <div className="flex-1 flex items-center justify-center relative my-0">
                            {particles.map(p => <div key={p.id} className="absolute w-12 h-12 anim-particle z-50" style={{top: p.top, left: p.left}}><SmartImage assetKey={GEM_CONFIG[p.type].assetKey} /></div>)}
                            <div className="relative w-full max-w-[360px] aspect-[6/7] p-2">
                                <div className="absolute inset-0 css-board-frame z-0"></div>
                                <div className="grid grid-cols-6 grid-rows-7 gap-1 h-full w-full relative z-10 p-3">
                                    {board.map((row, r) => row.map((type, c) => (
                                        <div key={`${r}-${c}`} onMouseDown={(e)=>handleDragStart(e,r,c)} onTouchStart={(e)=>handleDragStart(e,r,c)} className={`relative w-full h-full flex items-center justify-center transition-transform active:scale-90 ${crushingCells.includes(`${r},${c}`) ? 'anim-crumble' : ''}`}>
                                             {type && <SmartImage assetKey={GEM_CONFIG[type].assetKey} className="drop-shadow-md" />}
                                        </div>
                                    )))}
                                </div>
                            </div>
                        </div>

                        <div className="relative z-20 w-full flex flex-col items-center pb-8">
                            <div className="relative w-64 h-8 css-hp-bar mb-[-10px] z-10"><div className="absolute top-0 left-0 h-full bg-green-500 transition-all duration-300" style={{width: `${(hero.hp/hero.maxHp)*100}%`}}></div><div className="absolute inset-0 flex items-center justify-between px-3 text-xs font-bold text-white game-font z-10"><span>HERO (ATK:{hero.atk})</span><span>{formatNumber(hero.hp)}</span></div></div>
                            <div className="relative w-36 h-36">
                                <div className={`w-full h-full ${heroAnim} anim-sway-hero z-30 relative`}><SmartImage assetKey="hero" className="drop-shadow-2xl scale-110 origin-bottom" /></div>
                                {punchEffect === 'hero' && <div className="absolute bottom-20 z-50 text-6xl anim-punch">üëä</div>}
                            </div>
                        </div>
                    </div>
                    
                    {floatingText.map(ft => <div key={ft.id} className="absolute z-[60] text-4xl font-black pointer-events-none text-center" style={{top: '40%', left: '50%', transform:'translateX(-50%)', color: ft.col, textShadow:'2px 2px 0 #000', animation: 'float-up-fade 1.5s ease-out forwards'}}>{ft.txt}</div>)}

                    {/* MODALS */}
                    {gameState === 'START' && <div className="absolute inset-0 z-50 bg-black/90 flex flex-col items-center justify-center"><h1 className="text-6xl font-black text-yellow-500 mb-8 game-font animate-pulse">PUZZLE<br/>HEROES</h1><button onClick={()=>{setGameState('BATTLE');setTurnBanner('START!');}} className="active:scale-95"><img src="https://res.cloudinary.com/dsutaioqw/image/upload/v1770120268/btn_play_rcewal.png" className="w-64"/></button></div>}
                    
                    {gameState === 'REWARD' && <div className="absolute inset-0 z-50 bg-black/95 flex flex-col items-center justify-center p-6 text-center"><h2 className="text-5xl font-black text-green-400 mb-4 game-font">VICTORY!</h2><div className="bg-slate-800 p-4 rounded-xl border border-yellow-500/50 mb-6"><div className="text-yellow-500 font-bold">REWARD</div><div className="text-3xl font-black text-white">+{formatNumber(Math.floor(15*Math.pow(1.085,level-1)))} Coins</div></div><div className="flex gap-4 w-full"><button onClick={()=>setGameState('SHOP')} className="flex-1 py-4 bg-slate-700 rounded-xl font-bold border-b-4 border-slate-900">SHOP</button><button onClick={handleNextLevel} className="flex-[2] py-4 bg-yellow-500 rounded-xl font-black text-slate-900 border-b-4 border-yellow-700">NEXT ‚ñ∂</button></div></div>}

                    {gameState === 'REVIVE' && <div className="absolute inset-0 z-[60] bg-red-900/95 flex flex-col items-center justify-center p-6 text-center anim-modal"><h2 className="text-6xl font-black text-white mb-2 game-font">YOU DIED</h2><div className="text-xl text-white/80 mb-6">Stage {level}</div><div className="w-full max-w-sm space-y-3"><button onClick={()=>handleRevive('star')} className="w-full py-4 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-xl font-black text-xl shadow-lg border-b-4 border-yellow-800 active:border-b-0 active:translate-y-1">‚≠ê 1 Star (Full HP)</button><button onClick={()=>handleRevive('coin')} disabled={totalCoins<getRevivePrice()} className={`w-full py-4 rounded-xl font-bold border-b-4 active:border-b-0 active:translate-y-1 ${totalCoins>=getRevivePrice()?'bg-blue-600 border-blue-800':'bg-slate-600 border-slate-700 opacity-50'}`}>üí∞ {formatNumber(getRevivePrice())} (50% HP)</button><div className="h-px bg-white/20 my-2"></div><button onClick={handleGiveUp} className="text-white/70 border border-white/30 px-6 py-3 rounded-lg w-full font-bold">GIVE UP (Reset Stage)</button></div></div>}

                    {gameState === 'SHOP' && <div className="absolute inset-0 z-[60] bg-slate-900 flex flex-col p-4"><div className="flex justify-between mb-4"><h2 className="text-3xl text-yellow-400 font-black">SHOP</h2><button onClick={()=>setGameState('BATTLE')} className="bg-slate-700 px-4 py-2 rounded font-bold">CLOSE</button></div><div className="flex-1 overflow-y-auto space-y-4"><div className="space-y-2"><h3 className="text-sm font-bold text-slate-400">UPGRADES (Price +15%/Lvl)</h3>{['atk','hp'].map(t=><div key={t} className="bg-slate-800 p-3 rounded-xl flex justify-between items-center"><div><div className="font-bold uppercase">{t} UP</div><div className="text-xs text-slate-400">Lvl: {itemCounts[t]||0}</div></div><button onClick={()=>upgradeStats(t)} disabled={totalCoins<getUpgradePrice(t)} className={`px-4 py-2 rounded font-bold border-b-4 ${totalCoins>=getUpgradePrice(t)?'bg-blue-600 border-blue-800':'bg-slate-600 border-slate-700 opacity-50'}`}>üí∞{formatNumber(getUpgradePrice(t))}</button></div>)}</div><div className="space-y-2"><h3 className="text-sm font-bold text-slate-400">ITEMS (Price +10%/Buy)</h3>{['potion','bomb','shuffle'].map(t=><div key={t} className="bg-slate-800 p-3 rounded-xl flex justify-between items-center"><div><div className="font-bold capitalize">{t}</div><div className="text-xs text-slate-400">Owned: {inventory[t]}</div></div><button onClick={()=>buyItem(t)} disabled={totalCoins<getItemPrice(t)} className={`px-4 py-2 rounded font-bold border-b-4 ${totalCoins>=getItemPrice(t)?'bg-slate-600 border-slate-800':'bg-slate-700 border-slate-800 opacity-50'}`}>üí∞{formatNumber(getItemPrice(t))}</button></div>)}</div></div></div>}
                    
                    {showProfileModal && <div className="absolute inset-0 z-[80] bg-black/90 flex items-center justify-center p-6"><div className="bg-slate-800 border-4 border-slate-600 rounded-2xl p-6 w-full max-w-sm"><button onClick={()=>setShowProfileModal(false)} className="absolute top-4 right-4 text-white">‚úñ</button><h2 className="text-2xl font-black text-center mb-4">PROFILE</h2>{user?<button onClick={window.logoutGoogle} className="w-full py-3 bg-red-600 rounded font-bold">LOGOUT</button>:<><button onClick={window.loginGoogle} className="w-full py-3 bg-blue-600 rounded font-bold mb-2">LOGIN GOOGLE</button><button onClick={()=>{const n=prompt("Nama:",activeUserName);if(n){localStorage.setItem('guest_player_name',n);window.location.reload();}}} className="w-full py-3 bg-slate-600 rounded font-bold">GANTI NAMA</button></>}</div></div>}

                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GameApp />);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Puzzle Heroes RPG + Firebase Auth</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');

body {
    font-family: 'Fredoka One', sans-serif;
    background-color: var(--tg-theme-bg-color, #0f172a);
    color: white;
    overflow: hidden;
    touch-action: none;
    user-select: none;
}

/* ============================= */
/* ANIMASI EXISTING (RINGKAS) */
/* ============================= */
@keyframes crumble {
    0% { transform: scale(1); opacity:1; filter: brightness(1.5); }
    100% { transform: scale(0.2) translateY(20px) rotate(45deg); opacity:0; }
}
.anim-crumble {
    animation: crumble 0.4s ease-in forwards;
    pointer-events: none;
}

/* ============================= */
/* ðŸ”¥ ANIMASI JATUH (BARU) */
/* ============================= */
@keyframes drop-in {
    0% { transform: translateY(-100%); opacity: 0; }
    60% { transform: translateY(5%); opacity: 1; }
    100% { transform: translateY(0); opacity: 1; }
}
.anim-fall {
    animation: drop-in 0.4s cubic-bezier(0.25, 1, 0.5, 1) backwards;
}

img {
    -webkit-user-drag: none;
    user-select: none;
    pointer-events: none;
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyBXxNettfJao-Eb-Y_a1dNuZ8_DOiX_-fo",
    authDomain: "puzzle-heroes-d5df2.firebaseapp.com",
    projectId: "puzzle-heroes-d5df2",
    storageBucket: "puzzle-heroes-d5df2.firebasestorage.app",
    messagingSenderId: "63425481716",
    appId: "1:63425481716:web:e496e835b3d071235cc7a1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

window.loginGoogle = async () => {
    const result = await signInWithPopup(auth, provider);
    return result.user;
};

window.logoutGoogle = async () => {
    await signOut(auth);
    location.reload();
};

window.authListener = (cb) => {
    onAuthStateChanged(auth, (user) => cb(user || null));
};

window.loadCloudData = async (uid) => {
    const snap = await getDoc(doc(db, "players", uid.toString()));
    return snap.exists() ? snap.data() : null;
};

window.saveCloudData = async (uid, data) => {
    await setDoc(doc(db, "players", uid.toString()), data, { merge:true });
};
</script>
</head>

<body>
<div id="root"></div>

  <script type="text/babel">
const { useState, useEffect } = React;

/* =========================
   KONFIGURASI GAME
========================= */
const BOARD_ROWS = 7;
const BOARD_COLS = 6;
const GEM_TYPES = ['red','blue','green','yellow','purple'];

const GEM_CONFIG = {
  red:    { assetKey:'ðŸ”¥', effect:'dmg', val:1 },
  blue:   { assetKey:'ðŸ’§', effect:'dmg', val:1 },
  yellow: { assetKey:'âš¡', effect:'dmg', val:1.5 },
  green:  { assetKey:'ðŸŒ¿', effect:'heal', val:1.5 },
  purple: { assetKey:'ðŸ›¡ï¸', effect:'shd', val:2 },
};

const SmartImage = ({ assetKey }) => (
  <div className="text-2xl select-none">{assetKey}</div>
);

/* =========================
   MAIN GAME APP
========================= */
function GameApp() {

  /* ===== STATE UTAMA ===== */
  const [board, setBoard] = useState([]);
  const [isProcessing, setIsProcessing] = useState(false);
  const [crushingCells, setCrushingCells] = useState([]);

  /* ===== ðŸ”¥ STATE BARU (ANIMASI JATUH) ===== */
  const [isFalling, setIsFalling] = useState(false);

  /* =========================
     INIT BOARD
  ========================= */
  useEffect(() => {
    const initBoard = [];
    for(let r=0;r<BOARD_ROWS;r++){
      const row=[];
      for(let c=0;c<BOARD_COLS;c++){
        row.push(GEM_TYPES[Math.floor(Math.random()*GEM_TYPES.length)]);
      }
      initBoard.push(row);
    }
    setBoard(initBoard);
  },[]);

  /* =========================
     CEK MATCH
  ========================= */
  const checkMatches = (b) => {
    const matches = new Set();

    for(let r=0;r<BOARD_ROWS;r++){
      for(let c=0;c<BOARD_COLS-2;c++){
        const t=b[r][c];
        if(t && b[r][c+1]===t && b[r][c+2]===t){
          matches.add(`${r},${c}`);
          matches.add(`${r},${c+1}`);
          matches.add(`${r},${c+2}`);
        }
      }
    }

    for(let r=0;r<BOARD_ROWS-2;r++){
      for(let c=0;c<BOARD_COLS;c++){
        const t=b[r][c];
        if(t && b[r+1][c]===t && b[r+2][c]===t){
          matches.add(`${r},${c}`);
          matches.add(`${r+1},${c}`);
          matches.add(`${r+2},${c}`);
        }
      }
    }

    return [...matches].map(s=>{
      const [r,c]=s.split(',').map(Number);
      return {r,c};
    });
  };

  /* =========================
     RESOLVE BOARD (FIX FINAL)
  ========================= */
  const resolveBoard = async (currentBoard) => {
    let activeBoard = currentBoard.map(r=>[...r]);
    let loopCount = 0;
    let hasMatch = true;

    while(hasMatch && loopCount < 10){
      const matches = checkMatches(activeBoard);

      if(matches.length === 0){
        hasMatch = false;
        break;
      }

      setCrushingCells(matches.map(m=>`${m.r},${m.c}`));
      await new Promise(r=>setTimeout(r,400));

      matches.forEach(m => activeBoard[m.r][m.c] = null);
      setCrushingCells([]);

      /* ===== GRAVITY ===== */
      for(let c=0;c<BOARD_COLS;c++){
        let empty=0;
        for(let r=BOARD_ROWS-1;r>=0;r--){
          if(activeBoard[r][c]===null) empty++;
          else if(empty>0){
            activeBoard[r+empty][c]=activeBoard[r][c];
            activeBoard[r][c]=null;
          }
        }
        for(let i=0;i<empty;i++){
          activeBoard[i][c]=GEM_TYPES[Math.floor(Math.random()*GEM_TYPES.length)];
        }
      }

      /* ===== ðŸ”¥ TRIGGER FALL ANIMATION ===== */
      setIsFalling(true);
      setBoard(activeBoard.map(r=>[...r]));

      setTimeout(()=>setIsFalling(false),450);
      await new Promise(r=>setTimeout(r,450));

      loopCount++;
    }

    setIsProcessing(false);
  };

  /* =========================
     INPUT (TEST)
  ========================= */
  const handleClick = () => {
    if(isProcessing) return;
    setIsProcessing(true);
    resolveBoard(board);
  };

  /* =========================
     RENDER
  ========================= */
  return (
    <div className="w-full h-screen flex items-center justify-center bg-slate-900">
      <div className="grid grid-cols-6 grid-rows-7 gap-1 w-[360px] aspect-[6/7] p-3 bg-slate-800 rounded-xl">

        {board.map((row,r)=>row.map((type,c)=>(
          <div
            key={`${r}-${c}`}
            onClick={handleClick}
            className={`
              relative flex items-center justify-center
              bg-slate-700 rounded
              transition-transform active:scale-90
              ${crushingCells.includes(`${r},${c}`) ? 'anim-crumble' : ''}
              ${isFalling ? 'anim-fall' : ''}
            `}
            style={isFalling ? { animationDelay: `${c * 30}ms` } : {}}
          >
            {type && <SmartImage assetKey={GEM_CONFIG[type].assetKey} />}
          </div>
        )))}

      </div>
    </div>
  );
}
    <script type="text/babel">
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<GameApp />);
</script>

</body>
</html>

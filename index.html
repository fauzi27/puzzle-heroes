<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Puzzle Heroes RPG: Fixed</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Verdana&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');
        
        body { 
            font-family: 'Fredoka One', 'Verdana', sans-serif; 
            background-color: #0f172a; 
            color: #ffffff;
            overflow: hidden; 
            touch-action: none; 
            user-select: none; 
            -webkit-user-select: none; 
        }
        .game-font { text-shadow: 2px 2px 0px #000; letter-spacing: 1px; }
        
        /* Animasi Stabil (Anti-Glitch) */
        @keyframes sway-hero { 0%, 100% { transform: translateX(-3px); } 50% { transform: translateX(3px); } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-6px); } }
        @keyframes punch-pop { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.5); opacity: 1; } 100% { transform: scale(1); opacity: 0; } }
        @keyframes float-up-fade { 0% { transform: translate(-50%, 0) scale(1); opacity: 1; } 100% { transform: translate(-50%, -80px) scale(1.2); opacity: 0; } }
        @keyframes drop-in { 0% { transform: translateY(-100%); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        @keyframes pulse-special { 0% { filter: brightness(1); transform: scale(1); } 50% { filter: brightness(1.3); transform: scale(1.1); } 100% { filter: brightness(1); transform: scale(1); } }
        
        /* Screen Shake (Pengganti Flash yang bikin Glitch) */
        @keyframes shake-hard { 0%, 100% { transform: translate(0,0); } 20% { transform: translate(-5px, 5px); } 40% { transform: translate(5px, -5px); } 60% { transform: translate(-5px, -5px); } 80% { transform: translate(5px, 5px); } }

        .anim-fall { animation: drop-in 0.3s cubic-bezier(0.25, 1, 0.5, 1) backwards; }
        .anim-float { animation: float 3s ease-in-out infinite; }
        .anim-punch { animation: punch-pop 0.4s ease-out forwards; z-index: 100; pointer-events: none; }
        .anim-shake { animation: shake-hard 0.3s ease-in-out; }
        .anim-special { animation: pulse-special 1s infinite ease-in-out; z-index: 20; }
        
        .css-board-frame {
            background: rgba(15, 23, 42, 0.95);
            border: 6px solid #334155;
            border-radius: 12px;
            box-shadow: 0 0 0 2px #1e293b, inset 0 0 20px rgba(0,0,0,0.8);
        }
        
        .css-hp-bar {
            background: #1e293b; 
            border: 2px solid #475569; 
            border-radius: 6px;
            position: relative; 
            overflow: hidden;
        }

        .btn-game { border-bottom-width: 3px; transition: all 0.1s; }
        .btn-game:active { border-bottom-width: 0px; transform: translateY(3px); }
        .star-icon { width: 16px; height: 16px; display: inline-block; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23eab308'%3E%3Cpath d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/%3E%3C/svg%3E"); background-size: contain; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXxNettfJao-Eb-Y_a1dNuZ8_DOiX_-fo",
            authDomain: "puzzle-heroes-d5df2.firebaseapp.com",
            projectId: "puzzle-heroes-d5df2",
            storageBucket: "puzzle-heroes-d5df2.firebasestorage.app",
            messagingSenderId: "63425481716",
            appId: "1:63425481716:web:e496e835b3d071235cc7a1",
            measurementId: "G-TCN0MV463X"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        window.loginGoogle = async () => { try { const r = await signInWithPopup(auth, provider); return r.user; } catch (e) { alert(e.message); return null; } };
        window.logoutGoogle = async () => { await signOut(auth); window.location.reload(); };
        window.authListener = (cb) => onAuthStateChanged(auth, cb);
        
        // FUNGSI LOAD DATA YANG DIPERBAIKI (Membaca ID sebagai String)
        window.loadCloudData = async (uid) => {
            if (!uid) return null;
            try {
                const docRef = doc(db, "players", uid.toString()); // Pastikan String
                const docSnap = await getDoc(docRef);
                return docSnap.exists() ? docSnap.data() : null;
            } catch (error) { console.error("Load Error:", error); return null; }
        };

        window.saveCloudData = async (uid, data) => {
            if (!uid || uid === 'guest') return;
            try { await setDoc(doc(db, "players", uid.toString()), data, { merge: true }); } catch (error) { console.error("Save Error", error); }
        };
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const ASSETS = {
          btn_play: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120268/btn_play_rcewal.png",
          bg_main: "https://res.cloudinary.com/dsutaioqw/image/upload/v1/puzzle%20hero/bg_main.png",
          hero: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120266/hero_knqmzd.png",
          enemy_goblin: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120266/monster_goblin_lcvfpv.png",
          enemy_boss: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120266/monster_bos_tn2b0a.png",
          gem_fire: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120267/gem-fire_rhcs6t.png", 
          gem_water: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120266/gem_water_yk5zsx.png",
          gem_nature: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120267/gem_nature_jj3l1g.png",
          gem_lightning: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120267/gem_lightning_lu9s2z.png",
          gem_shield: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120267/gem_shield_bdizjp.png",
        };

        const BOARD_ROWS = 7;
        const BOARD_COLS = 6;
        const GEM_TYPES = ['red', 'blue', 'green', 'yellow', 'purple'];
        const GEM_CONFIG = {
          red:    { assetKey: 'gem_fire',      effect: 'dmg', val: 1.0, color: '#ef4444' },
          blue:   { assetKey: 'gem_water',     effect: 'dmg', val: 1.0, color: '#3b82f6' },
          yellow: { assetKey: 'gem_lightning', effect: 'dmg', val: 1.5, color: '#eab308' },
          green:  { assetKey: 'gem_nature',    effect: 'heal', val: 1.5, color: '#22c55e' },
          purple: { assetKey: 'gem_shield',    effect: 'shd', val: 2.0, color: '#a855f7' },
        };
        const MONSTER_NAMES = ["Slime", "Goblin", "Wolf", "Orc", "Troll", "Golem", "Warlock", "Dragon", "Demon", "God"];
        
        const formatNumber = (num) => {
            if (isNaN(num)) return "0";
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        };

        // --- GAME LOGIC BARU (2x2, Bom, Nova) ---
        // Helper: Create Gem Object
        const createGem = (forceType) => ({
            id: Math.random().toString(36).substr(2, 9),
            type: forceType || GEM_TYPES[Math.floor(Math.random() * GEM_TYPES.length)],
            special: null 
        });

        // Helper: Check Matches with 2x2 Rule
        function checkMatches(boardToCheck) {
            const matched = new Set();
            const matchInfo = {};
            
            const addMatch = (r, c, type, id, length, direction) => {
                const key = `${r},${c}`;
                matched.add(key);
                if (!matchInfo[key] || length > matchInfo[key].length) {
                    matchInfo[key] = { type, id, length, direction };
                }
            };

            // Horizontal & Vertical
            for (let r = 0; r < BOARD_ROWS; r++) {
                for (let c = 0; c < BOARD_COLS; c++) {
                    const t = boardToCheck[r][c]?.type;
                    if (!t) continue;
                    // Horiz
                    let hLen = 1; while (c + hLen < BOARD_COLS && boardToCheck[r][c + hLen]?.type === t) hLen++;
                    if (hLen >= 3) for (let i = 0; i < hLen; i++) addMatch(r, c+i, t, `h-${r}-${c}`, hLen, 'h');
                    // Vert
                    let vLen = 1; while (r + vLen < BOARD_ROWS && boardToCheck[r + vLen][c]?.type === t) vLen++;
                    if (vLen >= 3) for (let i = 0; i < vLen; i++) addMatch(r+i, c, t, `v-${r}-${c}`, vLen, 'v');
                }
            }
            
            // 2x2 Square Rule
            for (let r = 0; r < BOARD_ROWS - 1; r++) {
                for (let c = 0; c < BOARD_COLS - 1; c++) {
                    const t = boardToCheck[r][c]?.type;
                    if (t && boardToCheck[r][c+1]?.type === t && boardToCheck[r+1][c]?.type === t && boardToCheck[r+1][c+1]?.type === t) {
                        [[r,c], [r,c+1], [r+1,c], [r+1,c+1]].forEach(([rr, cc]) => {
                            addMatch(rr, cc, t, `sq-${r}-${c}`, 4, 'square');
                        });
                    }
                }
            }
            
            return Array.from(matched).map(str => {
                const [r, c] = str.split(',').map(Number);
                return { r, c, ...matchInfo[str] };
            });
        }

        const SmartImage = ({ assetKey, className = "" }) => {
            const [error, setError] = useState(false);
            return (
                <div className={`relative w-full h-full overflow-hidden ${className}`}>
                    {!error && ASSETS[assetKey] ? <img src={ASSETS[assetKey]} className="w-full h-full object-contain" onError={() => setError(true)} /> : <div className="w-full h-full bg-slate-700/50"></div>}
                </div>
            );
        };

        function GameApp() {
            const tg = window.Telegram.WebApp;

            // --- USER & AUTH STATE (FIXED) ---
            const [user, setUser] = useState(null); 
            
            // LOGIKA ID: Google > Telegram > Guest Local
            const getActiveID = () => {
                if (user) return user.uid;
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) return tg.initDataUnsafe.user.id.toString();
                // Jika tidak ada di Telegram/Google, buat ID lokal
                let localId = localStorage.getItem('guest_player_id');
                if (!localId) { localId = 'guest_' + Date.now(); localStorage.setItem('guest_player_id', localId); }
                return localId;
            };

            const activeUserId = getActiveID();
            const activeUserName = user ? user.displayName : (tg.initDataUnsafe?.user?.first_name || localStorage.getItem('guest_player_name') || "Player");

            // Game State
            const [gameState, setGameState] = useState('START'); 
            const [level, setLevel] = useState(1);
            const [totalCoins, setTotalCoins] = useState(100); 
            const [bonusStats, setBonusStats] = useState({ hp: 0, atk: 0 }); 
            const [inventory, setInventory] = useState({ potion: 1, bomb: 0, shuffle: 1 });
            
            // Battle
            const [hero, setHero] = useState({ maxHp: 100, hp: 100, atk: 15, shield: 0 });
            const [enemy, setEnemy] = useState({ name: 'Loading', hp: 100, maxHp: 100, atk: 10 });
            const [board, setBoard] = useState([]);
            const [turn, setTurn] = useState('player'); 
            const [isProcessing, setIsProcessing] = useState(false);
            
            // VFX (Glitch Fixed: Removed screenFlash state)
            const [punchEffect, setPunchEffect] = useState(null); 
            const [floatingText, setFloatingText] = useState([]);
            const [dragState, setDragState] = useState(null); 
            const [crushingCells, setCrushingCells] = useState([]); 
            const [screenShake, setScreenShake] = useState(false); // New Shake effect

            // --- INIT ---
            useEffect(() => {
                tg.ready(); tg.expand();
                window.authListener((u) => setUser(u)); // Listener Login Google
                setBoard(createValidBoard());
            }, []);

            // --- LOAD DATA (FIXED) ---
            useEffect(() => {
                const loadData = async () => {
                    const data = await window.loadCloudData(activeUserId);
                    if (data) {
                        if (data.level) setLevel(data.level);
                        // FIX NAN: Cek 'coins' (baru) ATAU 'totalCoins' (lama)
                        const safeCoins = data.coins !== undefined ? data.coins : (data.totalCoins || 100);
                        setTotalCoins(safeCoins);
                        if (data.bonusStats) setBonusStats(data.bonusStats);
                        if (data.inventory) setInventory(data.inventory);
                    }
                };
                if (activeUserId && !activeUserId.startsWith('guest_')) loadData(); // Load jika bukan guest lokal baru
            }, [activeUserId]);

            // --- SAVE DATA ---
            useEffect(() => {
                if (activeUserId && !activeUserId.startsWith('guest_') && gameState !== 'BATTLE') {
                    window.saveCloudData(activeUserId, {
                        level, coins: totalCoins, totalCoins, // Simpan kedua format agar aman
                        bonusStats, inventory, username: activeUserName
                    });
                }
            }, [level, totalCoins, bonusStats, inventory, gameState]);

            // --- GAMEPLAY FUNCTIONS ---
            const createValidBoard = () => {
                let b; do { b = Array(BOARD_ROWS).fill(null).map(() => Array(BOARD_COLS).fill(null).map(() => createGem())); } 
                while (checkMatches(b).length > 0);
                return b;
            };

            const calculateHeroStats = () => {
                // EXPO UPGRADE: Tiap level upgrade nambah stat
                const baseHp = 100 + (bonusStats.hp * 10);
                const baseAtk = 15 + (bonusStats.atk * 2);
                return { maxHp: baseHp, hp: baseHp, atk: baseAtk, shield: 0 };
            };

            const generateEnemy = () => {
                const isBoss = level % 5 === 0;
                // EXPO ENEMY: Musuh makin kuat tiap level
                const scale = Math.pow(1.1, level);
                const idx = Math.min(Math.floor((level - 1) / 5), MONSTER_NAMES.length - 1);
                return {
                    name: isBoss ? `BOSS ${MONSTER_NAMES[idx]}` : MONSTER_NAMES[idx],
                    maxHp: Math.floor(100 * scale * (isBoss ? 2.5 : 1)),
                    hp: Math.floor(100 * scale * (isBoss ? 2.5 : 1)),
                    atk: Math.floor(10 * scale * (isBoss ? 1.5 : 1)),
                    isBoss
                };
            };

            const triggerShake = () => { setScreenShake(true); tg.HapticFeedback.impactOccurred('medium'); setTimeout(() => setScreenShake(false), 300); };
            
            const spawnText = (txt, color) => {
                 const id = Date.now() + Math.random();
                 setFloatingText(p => [...p, { id, txt, color }]);
                 setTimeout(() => setFloatingText(prev => prev.filter(item => item.id !== id)), 1500); 
            };

            // --- MATCH RESOLVER (CORE ENGINE) ---
            const resolveBoard = async (currentBoard) => {
                let activeBoard = currentBoard.map(row => row.map(c => ({...c})));
                let hasMatches = true;
                let loopCount = 0;

                while (hasMatches && loopCount < 10) {
                    const matches = checkMatches(activeBoard);
                    if (matches.length === 0) { hasMatches = false; break; }

                    // Grouping Logic
                    const groups = {};
                    matches.forEach(m => { if(!groups[m.id]) groups[m.id] = []; groups[m.id].push(m); });
                    let totalDmg = 0; let totalHeal = 0; let totalShield = 0;
                    const newSpecials = [];

                    Object.values(groups).forEach(grp => {
                        const rep = grp[0]; const type = activeBoard[rep.r][rep.c].type;
                        const len = grp.length;
                        
                        // Buat Special Gem
                        if (len >= 5) newSpecials.push({r: rep.r, c: rep.c, type, special: 'nova'});
                        else if (len === 4) newSpecials.push({r: rep.r, c: rep.c, type, special: 'bomb'});
                        
                        // Hitung Stat
                        const conf = GEM_CONFIG[type];
                        const mult = 1 + (len > 3 ? 0.5 : 0) + (rep.direction === 'square' ? 0.5 : 0);
                        
                        if (conf.effect === 'dmg') totalDmg += hero.atk * conf.val * mult;
                        if (conf.effect === 'heal') totalHeal += (hero.maxHp * 0.05) * mult;
                        if (conf.effect === 'shd') totalShield += 5 * mult;

                        // Efek Special (Bom/Nova)
                        grp.forEach(m => {
                            const cell = activeBoard[m.r][m.c];
                            if (cell.special === 'bomb') {
                                for(let rr=m.r-1; rr<=m.r+1; rr++) for(let cc=m.c-1; cc<=m.c+1; cc++) 
                                    if(activeBoard[rr]?.[cc] && !matches.find(x=>x.r===rr && x.c===cc)) matches.push({r:rr, c:cc});
                                spawnText("BOOM!", "#ef4444"); triggerShake();
                            }
                            if (cell.special === 'nova') {
                                for(let rr=0; rr<BOARD_ROWS; rr++) for(let cc=0; cc<BOARD_COLS; cc++)
                                    if(activeBoard[rr][cc]?.type === type) matches.push({r:rr, c:cc});
                                spawnText("NOVA!", "#ffffff"); triggerShake();
                            }
                        });
                    });

                    // Apply Effect & Indicator
                    if (totalDmg > 0) {
                        setEnemy(p => ({...p, hp: Math.max(0, p.hp - Math.floor(totalDmg))}));
                        setPunchEffect('enemy'); setTimeout(()=>setPunchEffect(null), 400);
                        spawnText(`-${Math.floor(totalDmg)}`, '#ef4444');
                    }
                    if (totalHeal > 0) {
                        setHero(p => ({...p, hp: Math.min(p.maxHp, p.hp + Math.floor(totalHeal))}));
                        spawnText(`+${Math.floor(totalHeal)}`, '#22c55e');
                    }
                    if (totalShield > 0) setHero(p => ({...p, shield: p.shield + Math.floor(totalShield)}));

                    // Hapus Gem
                    setCrushingCells(matches.map(m => `${m.r},${m.c}`));
                    await new Promise(r => setTimeout(r, 400));
                    matches.forEach(m => activeBoard[m.r][m.c] = null);
                    newSpecials.forEach(s => activeBoard[s.r][s.c] = {...createGem(s.type), special: s.special});
                    setBoard(activeBoard.map(r=>[...r]));
                    setCrushingCells([]);

                    // Gravity
                    await new Promise(r => setTimeout(r, 100));
                    for(let c=0; c<BOARD_COLS; c++) {
                        let empty = 0;
                        for(let r=BOARD_ROWS-1; r>=0; r--) {
                            if(!activeBoard[r][c]) empty++;
                            else if(empty > 0) { activeBoard[r+empty][c] = activeBoard[r][c]; activeBoard[r][c] = null; }
                        }
                        for(let i=0; i<empty; i++) activeBoard[i][c] = createGem();
                    }
                    setBoard(activeBoard.map(r=>[...r]));
                    await new Promise(r => setTimeout(r, 400));
                    loopCount++;
                }

                setIsProcessing(false);
                if (enemy.hp > 0) {
                     setTurn('enemy'); 
                }
            };

            // Enemy AI
            useEffect(() => {
                if (turn === 'enemy' && enemy.hp > 0 && gameState === 'BATTLE' && !isProcessing) {
                    const enemyAct = async () => {
                        setIsProcessing(true);
                        await new Promise(r => setTimeout(r, 1000));
                        
                        // Attack Logic
                        const dmg = Math.max(0, enemy.atk - hero.shield);
                        const shieldLeft = Math.max(0, hero.shield - enemy.atk);
                        
                        if (enemy.atk > hero.shield) {
                            setHero(h => ({...h, hp: Math.max(0, h.hp - dmg), shield: shieldLeft}));
                            setPunchEffect('hero'); setTimeout(()=>setPunchEffect(null), 400);
                            spawnText(`-${dmg}`, '#ef4444');
                            triggerShake();
                        } else {
                            setHero(h => ({...h, shield: shieldLeft}));
                            spawnText("BLOCKED", "#a855f7");
                        }
                        
                        setTurn('player');
                        setIsProcessing(false);
                    }
                    enemyAct();
                }
            }, [turn, gameState, isProcessing]);

            // Win/Loss State
            useEffect(() => {
                if (enemy.hp <= 0 && gameState === 'BATTLE') { 
                    setTimeout(() => { setTotalCoins(c => c + Math.floor(20 * Math.pow(1.1, level))); setGameState('REWARD'); }, 800);
                }
                if (hero.hp <= 0 && gameState === 'BATTLE') setTimeout(() => setGameState('GAMEOVER'), 800);
            }, [enemy.hp, hero.hp]);

            // Input Handler
            const handleTouch = (e, type, r, c) => {
                if (isProcessing || turn !== 'player') return;
                const touch = e.changedTouches ? e.changedTouches[0] : e;
                
                if (type === 'start') setDragState({ r, c, x: touch.clientX, y: touch.clientY });
                else if (type === 'end' && dragState) {
                    const dx = touch.clientX - dragState.x;
                    const dy = touch.clientY - dragState.y;
                    if (Math.abs(dx) > 30 || Math.abs(dy) > 30) {
                         const r2 = Math.abs(dy) > Math.abs(dx) ? (dy > 0 ? dragState.r + 1 : dragState.r - 1) : dragState.r;
                         const c2 = Math.abs(dx) > Math.abs(dy) ? (dx > 0 ? dragState.c + 1 : dragState.c - 1) : dragState.c;
                         if (r2 >= 0 && r2 < BOARD_ROWS && c2 >= 0 && c2 < BOARD_COLS) {
                             const temp = board.map(r => r.map(c => ({...c})));
                             [temp[dragState.r][dragState.c], temp[r2][c2]] = [temp[r2][c2], temp[dragState.r][dragState.c]];
                             if (checkMatches(temp).length > 0) { setIsProcessing(true); setBoard(temp); resolveBoard(temp); }
                             else tg.HapticFeedback.notificationOccurred('error');
                         }
                    }
                    setDragState(null);
                }
            };

            const startBattle = () => {
                setHero(calculateHeroStats());
                setEnemy(generateEnemy());
                setBoard(createValidBoard());
                setTurn('player'); setIsProcessing(false); setGameState('BATTLE');
            };

            const buyUpgrade = (type) => {
                const lvl = bonusStats[type];
                const price = Math.floor((type === 'atk' ? 100 : 80) * Math.pow(1.5, lvl));
                if (totalCoins >= price) {
                    setTotalCoins(c => c - price);
                    setBonusStats(s => ({...s, [type]: s[type] + 1}));
                    tg.HapticFeedback.notificationOccurred('success');
                }
            };
            
            const getPrice = (type) => Math.floor((type === 'atk' ? 100 : 80) * Math.pow(1.5, bonusStats[type]));

            return (
                <div className={`fixed inset-0 w-full h-full flex flex-col bg-slate-900 overflow-hidden select-none ${screenShake ? 'anim-shake' : ''}`}
                     onTouchEnd={(e) => handleTouch(e, 'end')} onMouseUp={(e) => handleTouch(e, 'end')}>
                    
                    {/* Background */}
                    <img src={ASSETS.bg_main} className="absolute inset-0 w-full h-full object-cover opacity-40 z-0" />
                    
                    {/* INDICATOR FLOATING TEXT (Z-INDEX FIXED) */}
                    {floatingText.map(ft => (
                        <div key={ft.id} className="absolute z-[100] text-4xl font-black text-center whitespace-nowrap anim-float-text" 
                             style={{top: '40%', left: '50%', transform:'translateX(-50%)', color: ft.color, textShadow:'2px 2px 0 #000', animation: 'float-up-fade 1.5s ease-out forwards'}}>
                             {ft.txt}
                        </div>
                    ))}

                    {/* Header */}
                    <div className="relative z-10 flex justify-between items-center p-4">
                        <div className="bg-slate-800/80 px-4 py-1 rounded-full border border-yellow-500 flex items-center gap-2 shadow-lg" onClick={()=>setGameState('SHOP')}>
                            <span>ðŸ’°</span><span className="text-yellow-400 font-bold">{formatNumber(totalCoins)}</span>
                        </div>
                        <div className="font-bold text-white tracking-widest">LEVEL {level}</div>
                        <button onClick={()=>setGameState('SHOP')} className="bg-blue-600 px-3 py-1 rounded shadow font-bold text-sm">SHOP</button>
                    </div>

                    {/* Enemy */}
                    <div className="relative z-10 flex-1 flex flex-col items-center justify-center">
                        <div className={`w-32 h-32 relative ${punchEffect === 'enemy' ? 'anim-shake' : 'anim-float'}`}>
                            <SmartImage assetKey={enemy.isBoss ? 'enemy_boss' : 'enemy_goblin'} className="drop-shadow-2xl" />
                            {punchEffect === 'enemy' && <div className="absolute inset-0 flex items-center justify-center text-6xl anim-punch">ðŸ‘Š</div>}
                        </div>
                        <div className="w-48 h-5 css-hp-bar mt-2 bg-slate-800">
                            <div className="h-full bg-red-600 transition-all duration-300" style={{width: `${(enemy.hp/enemy.maxHp)*100}%`}}></div>
                            <div className="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white">{enemy.name} {formatNumber(enemy.hp)}</div>
                        </div>
                    </div>

                    {/* Board */}
                    <div className="relative z-20 flex justify-center px-4">
                        <div className="css-board-frame p-2 w-full max-w-[360px] aspect-[6/7] grid grid-cols-6 grid-rows-7 gap-1">
                            {board.map((row, r) => row.map((gem, c) => (
                                <div key={`${r}-${c}`} 
                                     onMouseDown={(e) => handleTouch(e, 'start', r, c)}
                                     onTouchStart={(e) => handleTouch(e, 'start', r, c)}
                                     className={`relative flex items-center justify-center transition-transform active:scale-90 ${gem?.id ? 'anim-fall' : ''} ${crushingCells.includes(`${r},${c}`) ? 'scale-0 transition-transform duration-300' : ''}`}
                                >
                                    {gem && (
                                        <>
                                            <SmartImage assetKey={GEM_CONFIG[gem.type].assetKey} className="drop-shadow-md z-10" />
                                            {gem.special === 'bomb' && <div className="absolute inset-0 bg-red-500/40 rounded-full anim-special border-2 border-red-500"/>}
                                            {gem.special === 'nova' && <div className="absolute -inset-1 border-2 border-dashed border-white rounded-full anim-special"/>}
                                        </>
                                    )}
                                </div>
                            )))}
                        </div>
                    </div>

                    {/* Hero */}
                    <div className="relative z-10 flex items-end justify-between p-4 max-w-[400px] mx-auto w-full">
                        <div className="relative w-24">
                             <div className={`w-24 h-24 ${punchEffect === 'hero' ? 'anim-shake' : 'anim-sway-hero'}`}>
                                <SmartImage assetKey="hero" className="scale-125 origin-bottom drop-shadow-xl" />
                                {punchEffect === 'hero' && <div className="absolute inset-0 flex items-center justify-center text-6xl anim-punch">ðŸ‘Š</div>}
                             </div>
                             <div className="w-24 h-4 css-hp-bar absolute -bottom-2 bg-slate-800">
                                 <div className="h-full bg-green-500 transition-all" style={{width: `${(hero.hp/hero.maxHp)*100}%`}}></div>
                                 <div className="absolute inset-0 flex items-center justify-center text-[9px] font-bold text-white">{formatNumber(hero.hp)}</div>
                             </div>
                        </div>
                        <div className="flex gap-2 mb-2">
                             {['potion', 'bomb', 'shuffle'].map(item => (
                                 <button key={item} onClick={() => {
                                     if (inventory[item] > 0 && turn === 'player' && !isProcessing) {
                                         setInventory(i => ({...i, [item]: i[item]-1}));
                                         if(item==='potion') { setHero(h=>({...h, hp:Math.min(h.maxHp, h.hp+50)})); spawnText("+HP", "#22c55e"); }
                                         if(item==='bomb') { setEnemy(e=>({...e, hp:Math.max(0, e.hp-hero.atk*3)})); spawnText("BOOM", "#f00"); triggerShake(); }
                                         if(item==='shuffle') setBoard(createValidBoard());
                                     }
                                 }} className={`w-10 h-10 rounded-full bg-slate-800 border-2 border-slate-600 flex items-center justify-center relative active:scale-90 ${inventory[item]===0?'opacity-50':''}`}>
                                     <span className="text-xl">{item==='potion'?'ðŸ§ª':(item==='bomb'?'ðŸ’£':'ðŸ”„')}</span>
                                     <span className="absolute -top-1 -right-1 bg-red-600 text-[9px] w-4 h-4 rounded-full flex items-center justify-center border border-slate-900">{inventory[item]}</span>
                                 </button>
                             ))}
                        </div>
                    </div>

                    {/* MODALS */}
                    {gameState === 'START' && (
                        <div className="absolute inset-0 z-50 bg-slate-900/95 flex flex-col items-center justify-center gap-6">
                            <h1 className="text-5xl text-yellow-500 font-black game-font text-center">PUZZLE<br/>HEROES</h1>
                            <button onClick={startBattle} className="w-64 py-4 bg-green-600 rounded-xl border-b-4 border-green-800 text-2xl font-bold active:translate-y-1">START GAME</button>
                            <div className="text-center text-slate-400 text-xs">ID: {activeUserId.slice(0,8)}...</div>
                        </div>
                    )}

                    {gameState === 'REWARD' && (
                        <div className="absolute inset-0 z-50 bg-black/90 flex flex-col items-center justify-center p-6 text-center">
                            <h2 className="text-4xl text-green-400 font-black mb-4">VICTORY!</h2>
                            <div className="bg-slate-800 p-4 rounded-xl border border-yellow-500 mb-6 w-full max-w-xs">
                                <div className="text-yellow-500 font-bold uppercase text-xs">Reward</div>
                                <div className="text-3xl font-black text-white">+{Math.floor(20 * Math.pow(1.1, level))} Coins</div>
                            </div>
                            <button onClick={()=>{setLevel(l=>l+1); startBattle();}} className="w-full max-w-xs py-4 bg-yellow-500 text-yellow-900 font-black text-xl rounded-xl border-b-4 border-yellow-700 active:translate-y-1">NEXT LEVEL</button>
                        </div>
                    )}

                    {gameState === 'GAMEOVER' && (
                        <div className="absolute inset-0 z-50 bg-red-900/95 flex flex-col items-center justify-center p-6 text-center">
                            <h2 className="text-5xl text-white font-black mb-6">DEFEAT</h2>
                            <button onClick={startBattle} className="px-8 py-4 bg-white text-red-900 font-black text-xl rounded-xl">TRY AGAIN</button>
                        </div>
                    )}

                    {gameState === 'SHOP' && (
                         <div className="absolute inset-0 z-50 bg-slate-900 flex flex-col">
                             <div className="p-4 bg-slate-800 shadow flex justify-between items-center"><h2 className="text-2xl text-yellow-400 font-black">SHOP</h2><button onClick={()=>setGameState('START')} className="bg-slate-600 px-3 py-1 rounded font-bold">CLOSE</button></div>
                             <div className="p-4 space-y-4 overflow-y-auto">
                                 {['atk', 'hp'].map(type => (
                                     <div key={type} className="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center">
                                         <div><div className="font-bold uppercase text-lg">{type} UP</div><div className="text-xs text-green-400">Lvl {bonusStats[type]}</div></div>
                                         <button onClick={()=>buyUpgrade(type)} className="px-4 py-2 rounded-lg bg-slate-600 text-white font-bold border-b-4 border-slate-700">ðŸ’° {formatNumber(getPrice(type))}</button>
                                     </div>
                                 ))}
                                 <div className="text-center text-xs text-slate-500 mt-4">More items coming soon...</div>
                             </div>
                         </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GameApp />);
    </script>
</body>
</html>

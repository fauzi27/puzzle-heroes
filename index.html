<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Puzzle Heroes RPG - Fixed UI & Logic</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Verdana&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');
        
        body { 
            font-family: 'Fredoka One', 'Verdana', sans-serif; 
            background-color: var(--tg-theme-bg-color, #0f172a); 
            color: var(--tg-theme-text-color, #ffffff);
            overflow: hidden; 
            touch-action: none; 
            user-select: none; 
            -webkit-user-select: none; 
        }
        .game-font { text-shadow: 2px 2px 0px #000; letter-spacing: 1px; }
        
        /* ANIMASI */
        @keyframes drop-in { 0% { transform: translateY(-100%); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        .anim-fall { animation: drop-in 0.4s cubic-bezier(0.25, 1, 0.5, 1) backwards; }
        @keyframes pop-in { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .anim-pop-in { animation: pop-in 0.3s ease-out forwards; }
        @keyframes sway-hero { 0%, 100% { transform: translateX(-3px); } 50% { transform: translateX(3px); } }
        @keyframes sway-enemy { 0%, 100% { transform: translateX(3px); } 50% { transform: translateX(-3px); } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-6px); } }
        @keyframes punch-pop { 0% { transform: scale(0) rotate(-45deg); opacity: 0; } 40% { transform: scale(1.5) rotate(0deg); opacity: 1; } 100% { transform: scale(1.5) translateY(-20px); opacity: 0; } }
        @keyframes hit-shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-6px); filter: brightness(2) sepia(1) hue-rotate(-50deg); } 40%, 80% { transform: translateX(6px); } }
        @keyframes particle-pop { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(1.5) translateY(-30px); opacity: 0; } }
        @keyframes crumble { 0% { transform: scale(1); opacity: 1; filter: brightness(1.5); } 100% { transform: scale(0); opacity: 0; } }
        @keyframes float-up { 0% { transform: translate(-50%, 0); opacity: 1; } 100% { transform: translate(-50%, -50px); opacity: 0; } }
        @keyframes bomb-flash { 0%, 100% { background: transparent; } 50% { background: rgba(255,255,255,0.8); } }

        .anim-float { animation: float 4s ease-in-out infinite; }
        .anim-sway-hero { animation: sway-hero 2s ease-in-out infinite; }
        .anim-sway-enemy { animation: sway-enemy 2s ease-in-out infinite; }
        .anim-punch { animation: punch-pop 0.5s ease-out forwards; z-index: 100; pointer-events: none; }
        .anim-hit { animation: hit-shake 0.4s ease-in-out; }
        .anim-particle { animation: particle-pop 0.6s ease-out forwards; pointer-events: none; }
        .anim-crumble { animation: crumble 0.3s ease-in forwards; pointer-events: none; }
        .anim-text { animation: float-up 1.5s ease-out forwards; pointer-events: none; }
        .anim-bomb { animation: bomb-flash 0.5s ease-out; }
        
        .css-board-frame { background: rgba(15, 23, 42, 0.8); border: 8px solid #334155; border-radius: 12px; box-shadow: 0 0 0 2px #1e293b, inset 0 0 20px rgba(0,0,0,0.8); }
        .css-hp-bar { background: #1e293b; border: 2px solid #475569; border-radius: 6px; overflow: hidden; position: relative; }
        .btn-game { border-bottom-width: 3px; transition: all 0.1s; }
        .btn-game:active { border-bottom-width: 0px; transform: translateY(3px); }
        .star-icon { display: inline-block; width: 16px; height: 16px; background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23eab308'%3E%3Cpath d='M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'/%3E%3C/svg%3E") center/contain no-repeat; }
        img { -webkit-user-drag: none; user-select: none; pointer-events: none; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXxNettfJao-Eb-Y_a1dNuZ8_DOiX_-fo",
            authDomain: "puzzle-heroes-d5df2.firebaseapp.com",
            projectId: "puzzle-heroes-d5df2",
            storageBucket: "puzzle-heroes-d5df2.firebasestorage.app",
            messagingSenderId: "63425481716",
            appId: "1:63425481716:web:e496e835b3d071235cc7a1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        window.initFirebaseAuth = async () => {
            try { await signInAnonymously(auth); } catch (e) { console.error("Auth Error:", e); }
        };
        window.authListener = (cb) => onAuthStateChanged(auth, cb);
        
        window.loadCloudData = async (playerId) => { 
            try { const d = await getDoc(doc(db, "players", String(playerId))); return d.exists() ? d.data() : null; } 
            catch (e) { return null; } 
        };
        window.saveCloudData = async (playerId, data) => { 
            try { await setDoc(doc(db, "players", String(playerId)), data, { merge: true }); } 
            catch (e) { console.error(e); } 
        };
        
        window.initFirebaseAuth();
    </script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const ASSETS = {
          btn_play: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120268/btn_play_rcewal.png",
          bg_main: "https://res.cloudinary.com/dsutaioqw/image/upload/v1/puzzle%20hero/bg_main.png",
          hero: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120266/hero_knqmzd.png",
          enemy_goblin: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120266/monster_goblin_lcvfpv.png",
          enemy_boss: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120266/monster_bos_tn2b0a.png",
          gem_fire: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120267/gem-fire_rhcs6t.png", 
          gem_water: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120266/gem_water_yk5zsx.png",
          gem_nature: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120267/gem_nature_jj3l1g.png",
          gem_lightning: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120267/gem_lightning_lu9s2z.png",
          gem_shield: "https://res.cloudinary.com/dsutaioqw/image/upload/v1770120267/gem_shield_bdizjp.png",
        };

        const BOARD_ROWS = 7; 
        const BOARD_COLS = 6;
        const GEM_TYPES = ['red', 'blue', 'green', 'yellow', 'purple'];
        const GEM_CONFIG = {
          red:    { assetKey: 'gem_fire',      effect: 'dmg', val: 1.0 },
          blue:   { assetKey: 'gem_water',     effect: 'dmg', val: 1.0 },
          yellow: { assetKey: 'gem_lightning', effect: 'dmg', val: 1.5 },
          green:  { assetKey: 'gem_nature',    effect: 'heal', val: 1.5 },
          purple: { assetKey: 'gem_shield',    effect: 'shd', val: 2.0 },
        };
        const MONSTER_NAMES = ["Slime", "Goblin", "Wolf", "Orc", "Troll", "Golem", "Warlock", "Dragon", "Demon", "God"];
        const formatNumber = (num) => (num >= 1000) ? (num / 1000).toFixed(1) + 'K' : num.toString();

        const SmartImage = ({ assetKey, className }) => (
            <div className={`relative overflow-hidden ${className}`}>
                <img src={ASSETS[assetKey]} className="w-full h-full object-contain" />
            </div>
        );

        function GameApp() {
            const tg = window.Telegram.WebApp;
            const [authUser, setAuthUser] = useState(null);
            
            const telegramUser = tg.initDataUnsafe?.user;
            const activePlayerId = telegramUser ? String(telegramUser.id) : (authUser ? authUser.uid : 'guest');
            const activeUserName = telegramUser ? telegramUser.first_name : 'Player';

            const [gameState, setGameState] = useState('START'); 
            const [level, setLevel] = useState(1);
            const [totalCoins, setTotalCoins] = useState(100); 
            const [inventory, setInventory] = useState({ potion: 1, bomb: 0, shuffle: 1 });
            const [upgradeLevels, setUpgradeLevels] = useState({ hp: 1, atk: 1 });
            const [isCloudLoaded, setIsCloudLoaded] = useState(false);
            const [rewardClaimed, setRewardClaimed] = useState(false); // Fix: Mencegah double claim koin

            const [showIAP, setShowIAP] = useState(false);
            const [fallingCells, setFallingCells] = useState([]); 

            const getShopCost = (type) => Math.floor((type==='atk'?100:80) * Math.pow(1.5, upgradeLevels[type]-1));
            const getShopValue = (type) => type==='atk' ? (2 + Math.floor((upgradeLevels[type]-1)*0.5)) : (10 + Math.floor((upgradeLevels[type]-1)*2));
            const calculateHeroStats = (lvl, upg) => {
                let bonusAtk = 0; for(let i=1; i<upg.atk; i++) bonusAtk += (2 + Math.floor((i-1)*0.5));
                let bonusHp = 0; for(let i=1; i<upg.hp; i++) bonusHp += (10 + Math.floor((i-1)*2));
                const baseHp = Math.floor(100 * Math.pow(1.07, lvl - 1));
                const baseAtk = Math.floor(15 * Math.pow(1.07, lvl - 1));
                return { maxHp: baseHp + bonusHp, hp: baseHp + bonusHp, atk: baseAtk + bonusAtk, shield: 0 };
            };

            const [hero, setHero] = useState(calculateHeroStats(level, upgradeLevels));
            const [enemy, setEnemy] = useState({ name: 'Loading', hp: 100, maxHp: 100, atk: 10 });
            
            useEffect(() => {
                tg.ready(); tg.expand();
                tg.BackButton.onClick(() => { setGameState('BATTLE'); tg.BackButton.hide(); });
                
                if(window.authListener) {
                    window.authListener(async (user) => {
                        setAuthUser(user);
                        if(user || telegramUser) {
                            if(window.loadCloudData) {
                                const data = await window.loadCloudData(activePlayerId);
                                if (data) {
                                    if(data.level) setLevel(data.level);
                                    if(data.totalCoins) setTotalCoins(data.totalCoins);
                                    if(data.inventory) setInventory(data.inventory);
                                    if(data.upgradeLevels) setUpgradeLevels(data.upgradeLevels);
                                }
                            }
                            setIsCloudLoaded(true);
                        }
                    });
                }
            }, []);

            useEffect(() => {
                if (!isCloudLoaded) return;
                const timer = setTimeout(() => {
                    if (window.saveCloudData) {
                        window.saveCloudData(activePlayerId, { 
                            level, totalCoins, inventory, upgradeLevels, 
                            lastUpdated: Date.now(), 
                            username: activeUserName 
                        });
                    }
                }, 2000);
                return () => clearTimeout(timer);
            }, [level, totalCoins, inventory, upgradeLevels, isCloudLoaded]);

            // Gameplay State
            const [board, setBoard] = useState([]);
            const [turn, setTurn] = useState('player'); 
            const [turnBanner, setTurnBanner] = useState(''); 
            const [isProcessing, setIsProcessing] = useState(false);
            const [crushingCells, setCrushingCells] = useState([]); 
            
            // Visuals
            const [heroAnim, setHeroAnim] = useState('');
            const [enemyAnim, setEnemyAnim] = useState('');
            const [punchEffect, setPunchEffect] = useState(null); 
            const [particles, setParticles] = useState([]);
            const [floatingText, setFloatingText] = useState([]);
            const [dragState, setDragState] = useState(null); 
            const [screenFlash, setScreenFlash] = useState('');

            const dragStateRef = useRef(dragState);
            const boardRef = useRef(board);
            const isProcessingRef = useRef(isProcessing);
            const turnRef = useRef(turn);

            useEffect(() => { dragStateRef.current = dragState; }, [dragState]);
            useEffect(() => { boardRef.current = board; }, [board]);
            useEffect(() => { isProcessingRef.current = isProcessing; }, [isProcessing]);
            useEffect(() => { turnRef.current = turn; }, [turn]);

            // Update Stats & Level Start
            useEffect(() => {
                if (isCloudLoaded) {
                    setHero(prev => { const s = calculateHeroStats(level, upgradeLevels); return { ...s, hp: s.maxHp, shield: 0 }; });
                    const isBoss = level % 5 === 0;
                    const idx = Math.min(Math.floor((level - 1) / 5), MONSTER_NAMES.length - 1);
                    setEnemy({
                        name: isBoss ? `BOSS ${MONSTER_NAMES[idx]}` : MONSTER_NAMES[idx],
                        maxHp: Math.floor(100 * Math.pow(1.08, level) * (isBoss ? 2.5 : 1)),
                        hp: Math.floor(100 * Math.pow(1.08, level) * (isBoss ? 2.5 : 1)),
                        atk: Math.floor(10 * Math.pow(1.08, level) * (isBoss ? 1.5 : 1)),
                        isBoss
                    });
                    setRewardClaimed(false); // Reset claim status setiap level baru
                }
            }, [isCloudLoaded, level, upgradeLevels]);

            // --- WIN LOGIC FIX (Poin 2) ---
            useEffect(() => {
                if(enemy.hp <= 0 && gameState === 'BATTLE' && !rewardClaimed) { 
                    setRewardClaimed(true); // Kunci agar tidak double
                    const reward = Math.floor(15 * Math.pow(1.085, level-1)); 
                    setTotalCoins(p => p + reward); 
                    spawnText(`VICTORY! +${reward} üí∞`, '#fbbf24');
                    setTimeout(() => setGameState('REWARD'), 1500); 
                }
                if(hero.hp <= 0 && gameState === 'BATTLE') setGameState('GAMEOVER');
            }, [enemy.hp, hero.hp]);

            function createValidBoard() {
                let newBoard, isValid = false;
                while (!isValid) {
                    newBoard = [];
                    for (let r=0; r<BOARD_ROWS; r++) { 
                        const row=[]; for(let c=0; c<BOARD_COLS; c++) row.push(GEM_TYPES[Math.floor(Math.random()*GEM_TYPES.length)]); 
                        newBoard.push(row); 
                    }
                    if (checkMatches(newBoard).length === 0) isValid = true;
                }
                return newBoard;
            }

            function checkMatches(boardToCheck) {
                const matched = new Set();
                const add = (r,c) => matched.add(`${r},${c}`);
                for (let r=0; r<BOARD_ROWS; r++) {
                    for (let c=0; c<BOARD_COLS-2; c++) { 
                        let t = boardToCheck[r][c]; 
                        if(t && boardToCheck[r][c+1]===t && boardToCheck[r][c+2]===t) { add(r,c); add(r,c+1); add(r,c+2); } 
                    } 
                }
                for (let r=0; r<BOARD_ROWS-2; r++) {
                    for (let c=0; c<BOARD_COLS; c++) { 
                        let t = boardToCheck[r][c]; 
                        if(t && boardToCheck[r+1][c]===t && boardToCheck[r+2][c]===t) { add(r,c); add(r+1,c); add(r+2,c); } 
                    } 
                }
                return Array.from(matched).map(s => { const [r,c] = s.split(',').map(Number); return {r,c}; });
            }

            useEffect(() => { setBoard(createValidBoard()); }, []);

            const resolveBoard = async (currentBoard) => {
                let activeBoard = currentBoard.map(row => [...row]); 
                let hasMatches = true;
                let loopCount = 0;
                
                while (hasMatches && loopCount < 10) {
                    const matches = checkMatches(activeBoard);
                    if (matches.length > 0) {
                        let dmg=0, heal=0, shd=0;
                        setCrushingCells(matches.map(m => `${m.r},${m.c}`));
                        
                        matches.forEach(m => {
                            const t = activeBoard[m.r][m.c];
                            if(t) {
                                const c = GEM_CONFIG[t];
                                if(c.effect==='dmg') dmg += hero.atk * c.val;
                                if(c.effect==='heal') heal += (hero.maxHp*0.05) * c.val;
                                if(c.effect==='shd') shd += 10 * c.val;
                                
                                const id = Date.now() + Math.random();
                                setParticles(p => [...p, { id, top: `${(m.r*100/BOARD_ROWS)+7}%`, left: `${(m.c*100/BOARD_COLS)+8}%`, type: t }]);
                                setTimeout(() => setParticles(p => p.filter(x=>x.id!==id)), 600);
                            }
                            activeBoard[m.r][m.c] = null; 
                        });

                        if(dmg>0) { setEnemy(e => ({...e, hp: Math.max(0, e.hp - Math.floor(dmg))})); triggerPunch('enemy'); spawnText(`-${Math.floor(dmg)}`, '#ef4444'); }
                        if(heal>0) { setHero(h => ({...h, hp: Math.min(h.maxHp, h.hp + Math.floor(heal))})); spawnText(`+${Math.floor(heal)}`, '#22c55e'); }
                        if(shd>0) { setHero(h => ({...h, shield: h.shield + Math.floor(shd)})); spawnText(`+${Math.floor(shd)}`, '#a855f7'); }

                        await new Promise(r => setTimeout(r, 400)); 
                        setCrushingCells([]);
                        
                        let newFallingCoords = [];
                        for(let c=0; c<BOARD_COLS; c++) {
                             let emptyCount = 0;
                             for(let r=BOARD_ROWS-1; r>=0; r--) {
                                 if(activeBoard[r][c] === null) emptyCount++;
                                 else if(emptyCount > 0) {
                                     activeBoard[r+emptyCount][c] = activeBoard[r][c];
                                     activeBoard[r][c] = null;
                                 }
                             }
                             for(let i=0; i<emptyCount; i++) {
                                 activeBoard[i][c] = GEM_TYPES[Math.floor(Math.random() * GEM_TYPES.length)];
                                 newFallingCoords.push(`${i},${c}`);
                             }
                             for(let r=0; r<BOARD_ROWS; r++) if(activeBoard[r][c] === null) activeBoard[r][c] = GEM_TYPES[0];
                        }
                        
                        setFallingCells(newFallingCoords);
                        setBoard(activeBoard.map(row => [...row])); 
                        setTimeout(() => setFallingCells([]), 450);
                        await new Promise(r => setTimeout(r, 450)); 
                        loopCount++;
                    } else {
                        hasMatches = false;
                    }
                }
                
                setIsProcessing(false);
                setTurn('enemy'); 
                setTurnBanner("GILIRAN MUSUH");
                setTimeout(() => setTurnBanner(''), 1500);
            };

            useEffect(() => {
                if (turn === 'enemy' && enemy.hp > 0 && gameState === 'BATTLE' && !isProcessing) {
                    setIsProcessing(true);
                    setTimeout(() => {
                        const dmg = Math.max(5, enemy.atk - hero.shield);
                        let finalDmg = dmg;
                        let shieldLeft = Math.max(0, hero.shield - enemy.atk);
                        
                        if(hero.shield > 0 && hero.shield >= enemy.atk) { finalDmg = 0; spawnText("BLOCKED", "#a855f7"); }
                        setHero(h => ({...h, hp: Math.max(0, h.hp - finalDmg), shield: shieldLeft}));
                        if(finalDmg > 0) { setHeroAnim('anim-hit'); spawnText(`-${finalDmg}`, '#ef4444'); triggerPunch('hero'); }
                        
                        const r = Math.floor(Math.random()*(BOARD_ROWS-1));
                        const c = Math.floor(Math.random()*(BOARD_COLS-1));
                        const nb = board.map(r=>[...r]); 
                        if(nb[r] && nb[r+1]) { 
                             [nb[r][c], nb[r][c+1]] = [nb[r][c+1], nb[r][c]]; 
                             setBoard(nb);
                        }

                        setTimeout(() => { setHeroAnim(''); setTurn('player'); setTurnBanner('GILIRAN KAMU'); setTimeout(()=>setTurnBanner(''),1000); setIsProcessing(false); }, 1000);
                    }, 1500);
                }
            }, [turn, gameState, isProcessing]);

            useEffect(() => {
                const handleGlobalUp = (e) => {
                    const currentDrag = dragStateRef.current;
                    if (!currentDrag) return;

                    const cx = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
                    const cy = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
                    const dx = cx - currentDrag.x;
                    const dy = cy - currentDrag.y;
                    
                    if (Math.abs(dx)>30 || Math.abs(dy)>30) {
                         const tr = Math.abs(dy)>Math.abs(dx) ? (dy>0?currentDrag.r+1:currentDrag.r-1) : currentDrag.r;
                         const tc = Math.abs(dx)>Math.abs(dy) ? (dx>0?currentDrag.c+1:currentDrag.c-1) : currentDrag.c;
                         
                         if (tr>=0 && tr<BOARD_ROWS && tc>=0 && tc<BOARD_COLS) {
                             const tb = boardRef.current.map(r=>[...r]); 
                             [tb[currentDrag.r][currentDrag.c], tb[tr][tc]] = [tb[tr][tc], tb[currentDrag.r][currentDrag.c]];
                             if (checkMatches(tb).length>0) { setIsProcessing(true); setBoard(tb); setTimeout(() => resolveBoard(tb), 200); }
                         }
                    }
                    setDragState(null);
                };

                window.addEventListener('mouseup', handleGlobalUp);
                window.addEventListener('touchend', handleGlobalUp);
                return () => {
                    window.removeEventListener('mouseup', handleGlobalUp);
                    window.removeEventListener('touchend', handleGlobalUp);
                };
            }, []);

            const handleDragStart = (e, r, c) => { 
                if(!isProcessingRef.current && turnRef.current==='player') {
                    setDragState({ r, c, x: e.touches ? e.touches[0].clientX : e.clientX, y: e.touches ? e.touches[0].clientY : e.clientY });
                }
            };

            const triggerPunch = (t) => { setPunchEffect(t); setTimeout(()=>setPunchEffect(null), 600); };
            const spawnText = (txt, col) => { const id = Date.now() + Math.random(); setFloatingText(p => [...p, {id, txt, col}]); setTimeout(() => setFloatingText(p => p.filter(x => x.id !== id)), 2000); };
            
            const useItem = (type) => {
                if(inventory[type] > 0 && turn === 'player' && !isProcessing) {
                    setInventory(p => ({...p, [type]: p[type]-1}));
                    if(type === 'potion') { setHero(h => ({...h, hp: Math.min(h.maxHp, h.hp + Math.floor(h.maxHp*0.3))})); spawnText("HEAL!", "#22c55e"); }
                    if(type === 'bomb') { setEnemy(e => ({...e, hp: Math.max(0, e.hp - Math.floor(hero.atk*2))})); spawnText("BOOM!", "#f97316"); setScreenFlash('anim-bomb'); setTimeout(() => setScreenFlash(''), 500); }
                    if(type === 'shuffle') { setBoard(createValidBoard()); spawnText("SHUFFLE", "#3b82f6"); }
                }
            };

            const buyItem = (item, cost) => {
                if(totalCoins >= cost) {
                    setTotalCoins(p => p - cost);
                    if(item === 'atk' || item === 'hp') setUpgradeLevels(p => ({...p, [item]: p[item] + 1})); 
                    else setInventory(p => ({...p, [item]: p[item] + 1}));
                    tg.HapticFeedback.impactOccurred('medium');
                } else tg.HapticFeedback.notificationOccurred('error');
            };

            const handleStarsPurchase = (coins, stars) => {
                if (!tg.initDataUnsafe?.user) { alert("[MODE BROWSER] Fitur pembayaran dinonaktifkan."); return; }
                const invoiceLink = "https://t.me/$D8iuOsDkIFQgBAAAUoNG2nbqTHI"; 
                tg.openInvoice(invoiceLink, (status) => {
                    if (status === 'paid') {
                        tg.MainButton.showProgress();
                        setTimeout(() => {
                            tg.MainButton.hideProgress();
                            setTotalCoins(prev => prev + coins);
                            window.saveCloudData(activePlayerId, { totalCoins: totalCoins + coins, lastUpdated: Date.now() });
                            tg.showAlert(`‚úÖ SUKSES!\n+${formatNumber(coins)} Koin.`);
                            setShowIAP(false); 
                        }, 1000);
                    } else if (status === 'failed') tg.showAlert("Pembayaran Gagal."); 
                });
            };

            return (
                <div className="flex flex-col h-screen w-full select-none relative overflow-hidden">
                    <div className={`absolute inset-0 z-50 pointer-events-none ${screenFlash}`}></div>
                    <div className="absolute inset-0 z-0 bg-slate-900"><img src={ASSETS.bg_main} className="w-full h-full object-cover opacity-40"/></div>
                    
                    <div className="absolute top-0 w-full z-40 p-2 flex justify-between items-start">
                        <div onClick={() => setGameState('SHOP')} className="flex items-center gap-2 bg-slate-900/80 border-2 border-yellow-600 rounded-full px-4 py-1 shadow-lg active:scale-95 transition-transform">
                            <span className="text-xl">üí∞</span><span className="text-yellow-400 font-black">{formatNumber(totalCoins)}</span>
                        </div>
                        <div className="text-white/90 font-black text-xl tracking-widest drop-shadow-md game-font">STAGE {level}</div>
                        <div className="flex flex-col items-end">
                            <div className="text-[10px] text-yellow-500 font-bold">PLAYER</div>
                            <div className="text-sm font-bold text-white">{activeUserName}</div>
                        </div>
                    </div>

                    {turnBanner && <div className="absolute top-40 w-full text-center z-50 text-4xl font-black text-white animate-pulse game-font drop-shadow-lg">{turnBanner}</div>}

                    <div className="flex flex-col justify-between h-full py-4 relative z-10">
                        {/* ENEMY */}
                        <div className="relative flex flex-col items-center mt-8"> 
                            <div className={`relative w-32 h-32 ${enemyAnim} anim-sway-enemy z-30`}>
                                 <SmartImage assetKey={enemy.isBoss ? 'enemy_boss' : 'enemy_goblin'} className="drop-shadow-2xl" />
                                 {punchEffect === 'enemy' && <div className="absolute inset-0 flex items-center justify-center text-6xl anim-punch">üí•</div>}
                            </div>
                            <div className="w-48 h-5 css-hp-bar -mt-2 z-20 relative">
                                <div className="absolute h-full bg-red-600 transition-all duration-300" style={{width: `${(enemy.hp/enemy.maxHp)*100}%`}}></div>
                                <div className="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white drop-shadow-md">{enemy.name} HP: {formatNumber(enemy.hp)}</div>
                            </div>
                        </div>

                        {/* BOARD */}
                        <div className="flex-1 flex items-center justify-center relative">
                            {particles.map(p => (<div key={p.id} className="absolute w-8 h-8 anim-particle z-50" style={{top:p.top, left:p.left}}><SmartImage assetKey={GEM_CONFIG[p.type].assetKey} /></div>))}
                            <div className="relative w-full max-w-[360px] aspect-[6/7] p-2">
                                <div className="absolute inset-0 css-board-frame"></div>
                                <div className="grid grid-cols-6 grid-rows-7 gap-1 h-full w-full relative z-10 p-3">
                                    {board.map((row, r) => row.map((type, c) => (
                                        <div key={`${r}-${c}`} 
                                             onMouseDown={(e) => handleDragStart(e, r, c)} 
                                             onTouchStart={(e) => handleDragStart(e, r, c)}
                                             className={`relative w-full h-full flex items-center justify-center transition-transform active:scale-90 ${crushingCells.includes(`${r},${c}`) ? 'anim-crumble' : ''} ${fallingCells.includes(`${r},${c}`) ? 'anim-fall' : ''}`}
                                             style={fallingCells.includes(`${r},${c}`) ? { animationDelay: `${c * 50}ms` } : {}}
                                        >
                                             {type && <SmartImage assetKey={GEM_CONFIG[type].assetKey} className="drop-shadow-sm" />}
                                        </div>
                                    )))}
                                </div>
                            </div>
                        </div>

                        {/* HERO & STATS (Poin 3 & 4) */}
                        <div className="relative z-20 w-full flex flex-col items-center pb-8">
                            {/* HP & Shield Bar */}
                            <div className="w-48 h-6 css-hp-bar mb-[-10px] z-10 relative bg-slate-800">
                                {/* HP Hijau */}
                                <div className="absolute h-full bg-green-500 transition-all duration-300" style={{width: `${(hero.hp/hero.maxHp)*100}%`}}></div>
                                {/* Shield Ungu Overlay */}
                                <div className="absolute h-full bg-purple-500/60 border-b-2 border-purple-300 transition-all duration-300" style={{width: `${Math.min(100, (hero.shield/hero.maxHp)*100)}%`}}></div>
                                <div className="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white drop-shadow-md">
                                    HP: {formatNumber(hero.hp)} {hero.shield > 0 ? `(+${hero.shield})` : ''}
                                </div>
                            </div>
                            
                            <div className="relative w-32 h-32 flex items-center justify-center">
                                {/* Hero Sprite */}
                                <div className={`w-full h-full ${heroAnim} anim-sway-hero relative`}><SmartImage assetKey="hero" /></div>
                                {punchEffect === 'hero' && <div className="absolute inset-0 flex items-center justify-center text-6xl anim-punch">üí•</div>}
                                
                                {/* Attack Badge (Poin 4) */}
                                <div className="absolute bottom-2 -left-2 bg-slate-800 border border-yellow-500 text-yellow-400 px-2 py-0.5 rounded-full text-xs font-bold flex items-center gap-1 shadow-lg z-20">
                                    ‚öîÔ∏è {formatNumber(hero.atk)}
                                </div>

                                {/* Items Container (Poin 3: Dirapikan) */}
                                <div className="absolute -right-6 top-4 flex flex-col gap-1.5 anim-float z-20">
                                    {['potion','bomb','shuffle'].map(i => (
                                        <button key={i} onClick={() => useItem(i)} className={`w-9 h-9 rounded-lg border-2 flex items-center justify-center bg-slate-700 shadow-md btn-game ${inventory[i] > 0 ? 'border-white' : 'opacity-50 grayscale border-slate-600'}`}>
                                            <span className="text-lg">{{potion:'üß™', bomb:'üí£', shuffle:'üîÑ'}[i]}</span>
                                            {inventory[i] > 0 && <span className="absolute -top-1.5 -right-1.5 bg-red-500 text-[8px] min-w-[14px] h-[14px] rounded-full flex items-center justify-center border border-slate-900 font-bold text-white">{inventory[i]}</span>}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>

                    {floatingText.map(t => (<div key={t.id} className="absolute left-1/2 top-1/2 -translate-x-1/2 text-4xl font-black anim-text z-[60]" style={{color:t.col}}>{t.txt}</div>))}

                    {gameState === 'START' && (
                        <div className="absolute inset-0 z-50 bg-black/90 flex flex-col items-center justify-center p-6">
                            <h1 className="text-5xl text-yellow-400 font-black mb-8 game-font text-center animate-pulse">PUZZLE<br/>HEROES</h1>
                            <button onClick={() => { setGameState('BATTLE'); setTurnBanner('START!'); }} className="w-64"><img src={ASSETS.btn_play} /></button>
                        </div>
                    )}
                    
                    {gameState === 'REWARD' && (
                        <div className="absolute inset-0 z-50 bg-black/95 flex flex-col items-center justify-center p-6">
                            <h2 className="text-5xl text-green-400 font-black mb-4">VICTORY</h2>
                            <div className="text-white text-xl mb-8">Reward: <span className="text-yellow-400">+{Math.floor(15 * Math.pow(1.085, level-1))} Coins</span></div>
                            <div className="flex gap-4">
                                <button onClick={() => setGameState('SHOP')} className="bg-slate-700 px-6 py-3 rounded-xl font-bold border-b-4 border-slate-900">SHOP</button>
                                <button onClick={() => { setLevel(l => l+1); setGameState('BATTLE'); }} className="bg-yellow-500 px-6 py-3 rounded-xl font-bold text-black border-b-4 border-yellow-700">NEXT STAGE</button>
                            </div>
                        </div>
                    )}
                    
                    {gameState === 'GAMEOVER' && (
                        <div className="absolute inset-0 z-50 bg-red-900/95 flex flex-col items-center justify-center p-6">
                            <h2 className="text-5xl text-white font-black mb-4">DEFEAT</h2>
                            <div className="text-white mb-8">Reached: Stage {level}</div>
                            <button onClick={() => { setLevel(1); setGameState('BATTLE'); }} className="bg-white text-black px-8 py-4 rounded-xl font-bold border-b-4 border-gray-400">TRY AGAIN</button>
                        </div>
                    )}

                    {(gameState === 'SHOP' || showIAP) && !showIAP && (
                        <div className="absolute inset-0 z-[60] bg-slate-900 flex flex-col p-4 anim-pop-in">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-3xl text-yellow-400 font-black">SHOP</h2>
                                {/* FIX Poin 1: Logika Kembali ke Battle jika musuh masih hidup */}
                                <button onClick={() => setGameState(enemy.hp > 0 ? 'BATTLE' : 'REWARD')} className="bg-red-500 px-3 py-1 rounded text-white font-bold">CLOSE</button>
                            </div>
                            <div className="bg-slate-800 p-4 rounded-xl mb-4 border border-yellow-500 flex justify-between">
                                <span className="text-gray-300">COINS:</span><span className="text-yellow-400 font-black text-xl">üí∞ {formatNumber(totalCoins)}</span>
                            </div>
                            <button onClick={()=>setShowIAP(true)} className="w-full py-3 mb-4 bg-gradient-to-r from-blue-600 to-blue-500 rounded-xl font-black text-white text-lg shadow-lg border-b-4 border-blue-800 active:border-b-0 active:translate-y-1 flex items-center justify-center gap-2">
                                <span className="star-icon"></span> GET COINS (STARS)
                            </button>
                            <div className="flex-1 overflow-y-auto space-y-3 pb-10">
                                <div className="text-xs text-white/50 font-bold uppercase tracking-wider mb-1">UPGRADES (Lvl {upgradeLevels.atk})</div>
                                <div className="bg-slate-800 p-3 rounded-xl flex justify-between items-center border border-slate-700">
                                    <div><div className="text-white font-bold text-lg">‚öîÔ∏è ATK UP <span className="text-green-400 text-sm">(+{getShopValue('atk')})</span></div><div className="text-xs text-gray-400">Current Base: {hero.atk}</div></div>
                                    <button onClick={() => buyItem('atk', getShopCost('atk'))} disabled={totalCoins < getShopCost('atk')} className={`px-4 py-2 rounded-lg font-bold border-b-4 ${totalCoins >= getShopCost('atk') ? 'bg-blue-600 border-blue-800 text-white' : 'bg-slate-600 border-slate-700 text-gray-500'}`}>üí∞{formatNumber(getShopCost('atk'))}</button>
                                </div>
                                <div className="bg-slate-800 p-3 rounded-xl flex justify-between items-center border border-slate-700">
                                    <div><div className="text-white font-bold text-lg">‚ù§Ô∏è HP UP <span className="text-green-400 text-sm">(+{getShopValue('hp')})</span></div><div className="text-xs text-gray-400">Current Base: {hero.maxHp}</div></div>
                                    <button onClick={() => buyItem('hp', getShopCost('hp'))} disabled={totalCoins < getShopCost('hp')} className={`px-4 py-2 rounded-lg font-bold border-b-4 ${totalCoins >= getShopCost('hp') ? 'bg-blue-600 border-blue-800 text-white' : 'bg-slate-600 border-slate-700 text-gray-500'}`}>üí∞{formatNumber(getShopCost('hp'))}</button>
                                </div>
                                <div className="text-xs text-white/50 font-bold uppercase tracking-wider mb-1 mt-4">ITEMS</div>
                                {['potion','bomb','shuffle'].map(i => {
                                    const cost = {potion:50, bomb:100, shuffle:30}[i];
                                    return (
                                        <div key={i} className="bg-slate-800 p-3 rounded-xl flex justify-between items-center border border-slate-700">
                                            <div><div className="text-white font-bold capitalize text-lg">{i}</div><div className="text-xs text-gray-400">Owned: {inventory[i]}</div></div>
                                            <button onClick={() => buyItem(i, cost)} disabled={totalCoins < cost} className={`px-4 py-2 rounded-lg font-bold border-b-4 ${totalCoins >= cost ? 'bg-green-600 border-green-800 text-white' : 'bg-slate-600 border-slate-700 text-gray-500'}`}>üí∞{cost}</button>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                    
                    {showIAP && (
                         <div className="absolute inset-0 z-[70] bg-black/95 flex flex-col p-6 items-center justify-center anim-pop-in">
                             <h2 className="text-3xl text-white font-black mb-6 game-font">BUY COINS</h2>
                             <div className="w-full max-w-sm space-y-4">
                                 <div onClick={() => handleStarsPurchase(1000, 50)} className="bg-slate-800 border-2 border-slate-600 p-4 rounded-xl flex justify-between items-center cursor-pointer active:scale-95 transition-transform">
                                    <div className="flex items-center gap-3"><div className="text-4xl">üí∞</div><div><div className="text-white font-black text-xl">1,000 Coins</div></div></div>
                                    <div className="bg-blue-600 text-white px-3 py-1 rounded-lg font-bold flex items-center gap-1"><span className="star-icon w-4 h-4"></span> 50</div>
                                </div>
                                 <div onClick={() => handleStarsPurchase(5000, 200)} className="bg-slate-800 border-2 border-yellow-600 p-4 rounded-xl flex justify-between items-center cursor-pointer active:scale-95 transition-transform">
                                    <div className="flex items-center gap-3"><div className="text-4xl">üíé</div><div><div className="text-white font-black text-xl">5,000 Coins</div></div></div>
                                    <div className="bg-blue-600 text-white px-3 py-1 rounded-lg font-bold flex items-center gap-1"><span className="star-icon w-4 h-4"></span> 200</div>
                                </div>
                                 <div onClick={() => handleStarsPurchase(15000, 500)} className="bg-slate-800 border-2 border-slate-600 p-4 rounded-xl flex justify-between items-center cursor-pointer active:scale-95 transition-transform">
                                    <div className="flex items-center gap-3"><div className="text-4xl">üëë</div><div><div className="text-white font-black text-xl">15,000 Coins</div></div></div>
                                    <div className="bg-blue-600 text-white px-3 py-1 rounded-lg font-bold flex items-center gap-1"><span className="star-icon w-4 h-4"></span> 500</div>
                                </div>
                             </div>
                             <button onClick={() => setShowIAP(false)} className="mt-8 text-white/70 font-bold border border-white/30 px-6 py-2 rounded-lg hover:bg-white/10">CANCEL</button>
                         </div>
                    )}
                </div>
            );
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GameApp />);
    </script>
</body>
</html>

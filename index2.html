<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Puzzle Heroes RPG + Firebase Auth</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');

body {
    font-family: 'Fredoka One', sans-serif;
    background:#0f172a;
    color:#fff;
    overflow:hidden;
}

/* ===================== */
/* ANIMASI TAMBAHAN */
/* ===================== */
@keyframes drop-in {
    0% { transform: translateY(-100%); opacity: 0; }
    60% { transform: translateY(5%); opacity: 1; }
    100% { transform: translateY(0); opacity: 1; }
}
.anim-fall {
    animation: drop-in 0.4s cubic-bezier(0.25, 1, 0.5, 1) backwards;
}

@keyframes crumble {
    from { transform: scale(1); opacity:1; }
    to { transform: scale(0.2) translateY(20px); opacity:0; }
}
.anim-crumble { animation: crumble 0.4s ease-in forwards; pointer-events:none; }

img { pointer-events:none; user-select:none; }
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

const BOARD_ROWS = 7;
const BOARD_COLS = 6;
const GEM_TYPES = ['red','blue','green','yellow','purple'];

const GEM_CONFIG = {
  red:{assetKey:'ðŸ”¥'},
  blue:{assetKey:'ðŸ’§'},
  green:{assetKey:'ðŸŒ¿'},
  yellow:{assetKey:'âš¡'},
  purple:{assetKey:'ðŸ›¡ï¸'}
};

const SmartImage = ({ assetKey }) => (
  <div className="text-2xl">{assetKey}</div>
);

function GameApp() {

  /* ===================== */
  /* STATE TAMBAHAN */
  /* ===================== */
  const [isFalling, setIsFalling] = useState(false);

  const [board, setBoard] = useState([]);
  const [isProcessing, setIsProcessing] = useState(false);
  const [crushingCells, setCrushingCells] = useState([]);

  useEffect(() => {
    const init = [];
    for(let r=0;r<BOARD_ROWS;r++){
      const row=[];
      for(let c=0;c<BOARD_COLS;c++){
        row.push(GEM_TYPES[Math.floor(Math.random()*GEM_TYPES.length)]);
      }
      init.push(row);
    }
    setBoard(init);
  },[]);

  const checkMatches = (b) => {
    const m=[];
    for(let r=0;r<BOARD_ROWS;r++){
      for(let c=0;c<BOARD_COLS-2;c++){
        if(b[r][c] && b[r][c]===b[r][c+1] && b[r][c]===b[r][c+2]){
          m.push({r,c},{r,c:c+1},{r,c:c+2});
        }
      }
    }
    return m;
  };

  /* ===================== */
  /* RESOLVE BOARD (FIXED) */
  /* ===================== */
  const resolveBoard = async (currentBoard) => {
    let activeBoard = currentBoard.map(r=>[...r]);
    let loopCount = 0;
    let hasMatches = true;

    while(hasMatches && loopCount < 10){
      const matches = checkMatches(activeBoard);
      if(matches.length === 0){ hasMatches=false; break; }

      setCrushingCells(matches.map(m=>`${m.r},${m.c}`));
      await new Promise(r=>setTimeout(r,400));

      matches.forEach(m=> activeBoard[m.r][m.c] = null);
      setCrushingCells([]);

      for(let c=0;c<BOARD_COLS;c++){
        let empty = 0;
        for(let r=BOARD_ROWS-1;r>=0;r--){
          if(activeBoard[r][c]===null) empty++;
          else if(empty>0){
            activeBoard[r+empty][c]=activeBoard[r][c];
            activeBoard[r][c]=null;
          }
        }
        for(let i=0;i<empty;i++){
          activeBoard[i][c]=GEM_TYPES[Math.floor(Math.random()*GEM_TYPES.length)];
        }
      }

      /* ===== TRIGGER ANIMASI JATUH ===== */
      setIsFalling(true);
      setBoard(activeBoard.map(r=>[...r]));
      setTimeout(()=>setIsFalling(false),450);
      await new Promise(r=>setTimeout(r,450));

      loopCount++;
    }
    setIsProcessing(false);
  };

  return (
    <div className="w-full h-screen flex items-center justify-center">
      <div className="grid grid-cols-6 grid-rows-7 gap-1 w-[360px] aspect-[6/7] p-3 bg-slate-800 rounded-xl">

        {board.map((row,r)=>row.map((type,c)=>(
          <div key={`${r}-${c}`}
            className={`
              relative flex items-center justify-center
              bg-slate-700 rounded
              transition-transform active:scale-90
              ${crushingCells.includes(`${r},${c}`) ? 'anim-crumble':''}
              ${isFalling ? 'anim-fall':''}
            `}
            style={isFalling ? { animationDelay:`${c*30}ms` } : {}}
            onClick={()=>{
              if(isProcessing) return;
              setIsProcessing(true);
              resolveBoard(board);
            }}
          >
            {type && <SmartImage assetKey={GEM_CONFIG[type].assetKey} />}
          </div>
        )))}

      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<GameApp />);
</script>
</body>
</html>
